<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 20px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .nav-panel { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input { flex: 1; min-width: 200px; height: 40px; padding: 0 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { height: 40px; padding: 0 20px; background: #1890ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #map { width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        #status { padding: 10px; background: #fafafa; border-radius: 5px; font-size: 14px; }
    </style>
    <!-- å…³é”®ï¼šä½¿ç”¨é«˜å¾·JSAPI Loader -->
    <script src="https://webapi.amap.com/loader.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="color: #1890ff;">ğŸï¸ æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿ</h1>
            <p>ä½¿ç”¨é«˜å¾·åœ°å›¾API - åµŒå…¥å¼æ¯”èµ›ä¸“ç”¨</p>
        </div>
        
        <div class="nav-panel">
            <div class="controls">
                <input type="text" id="dest-input" placeholder="è¾“å…¥ç›®çš„åœ°ï¼Œå¦‚ï¼šå¤©å®‰é—¨å¹¿åœº">
                <button id="loc-btn" onclick="getLocation()">ğŸ“ è·å–å½“å‰ä½ç½®</button>
                <button id="nav-btn" onclick="startNavigation()" disabled>ğŸš€ å¼€å§‹å¯¼èˆª</button>
                <button onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div id="map"></div>
            <div id="status">ç‚¹å‡»"è·å–å½“å‰ä½ç½®"å¼€å§‹</div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 12px;">
            <p>é«˜å¾·Key: 977b6123358698744cd4f2a96e219145</p>
            <p>Â© 2024 æ™ºèƒ½å¤´ç›”é¡¹ç›® - åµŒå…¥å¼æ¯”èµ›</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let myLocation = null;
        let currentMarker = null;
        let destMarker = null;
        
        // é¡µé¢åŠ è½½åç«‹å³åˆå§‹åŒ–åœ°å›¾
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½ï¼Œåˆå§‹åŒ–åœ°å›¾...');
            initMap();
        };
        
        // åˆå§‹åŒ–åœ°å›¾ - ä½¿ç”¨JSAPI Loaderç¡®ä¿åŠ è½½æˆåŠŸ
        function initMap() {
            AMapLoader.load({
                "key": "977b6123358698744cd4f2a96e219145",  // ä½¿ç”¨æ‚¨çš„Key
                "version": "2.0",
                "plugins": ['AMap.Geolocation', 'AMap.Geocoder', 'AMap.Driving', 'AMap.ToolBar']
            }).then((AMap) => {
                console.log('âœ… é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
                
                // åˆ›å»ºåœ°å›¾å®ä¾‹
                map = new AMap.Map('map', {
                    zoom: 12,
                    center: [116.397428, 39.90923], // åŒ—äº¬ä¸­å¿ƒ
                    resizeEnable: true
                });
                
                // æ·»åŠ å·¥å…·æ 
                map.addControl(new AMap.ToolBar({
                    position: 'RT'
                }));
                
                updateStatus('âœ… åœ°å›¾åŠ è½½å®Œæˆï¼å¯ä»¥å¼€å§‹ä½¿ç”¨', 'success');
                
                // è‡ªåŠ¨å°è¯•è·å–ä½ç½®ï¼ˆå¯é€‰ï¼‰
                // setTimeout(getLocation, 1000);
                
            }).catch((e) => {
                console.error('âŒ åœ°å›¾åŠ è½½å¤±è´¥:', e);
                updateStatus('âŒ åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’ŒKey', 'error');
            });
        }
        
        // è·å–å½“å‰ä½ç½®
        function getLocation() {
            if (!map) {
                updateStatus('åœ°å›¾æœªå°±ç»ª', 'error');
                return;
            }
            
            const btn = document.getElementById('loc-btn');
            btn.disabled = true;
            btn.textContent = 'å®šä½ä¸­...';
            
            updateStatus('æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...', 'info');
            
            // ä½¿ç”¨é«˜å¾·å®šä½æ’ä»¶
            const geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,    // é«˜ç²¾åº¦
                timeout: 10000,              // 10ç§’è¶…æ—¶
                maximumAge: 0,
                convert: true,
                showButton: false,
                panToLocation: true,
                zoomToAccuracy: true
            });
            
            map.addControl(geolocation);
            
            geolocation.getCurrentPosition((status, result) => {
                console.log('å®šä½ç»“æœ:', status, result);
                
                btn.disabled = false;
                btn.textContent = 'ğŸ“ è·å–å½“å‰ä½ç½®';
                
                if (status === 'complete') {
                    onLocationSuccess(result);
                } else {
                    onLocationError(result);
                }
            });
        }
        
        // å®šä½æˆåŠŸ
        function onLocationSuccess(result) {
            myLocation = result.position;
            
            // æ¸…é™¤æ—§æ ‡è®°
            if (currentMarker) {
                map.remove(currentMarker);
            }
            
            // åˆ›å»ºå½“å‰ä½ç½®æ ‡è®°
            currentMarker = new AMap.Marker({
                position: myLocation,
                map: map,
                title: 'æˆ‘çš„ä½ç½®',
                content: '<div style="background:#1890ff;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>'
            });
            
            // ç§»åŠ¨åˆ°ä½ç½®
            map.setCenter(myLocation);
            map.setZoom(16);
            
            // å¯ç”¨å¯¼èˆªæŒ‰é’®
            document.getElementById('nav-btn').disabled = false;
            
            // æ˜¾ç¤ºåœ°å€ä¿¡æ¯
            const address = result.addressComponent;
            const addr = address ? `${address.city || ''}${address.district || ''}` : 'å½“å‰ä½ç½®';
            
            updateStatus(`âœ… å®šä½æˆåŠŸï¼ä½ç½®ï¼š${addr}`, 'success');
        }
        
        // å®šä½å¤±è´¥
        function onLocationError(error) {
            console.error('å®šä½å¤±è´¥:', error);
            
            // ä½¿ç”¨IPå®šä½ä½œä¸ºåå¤‡
            updateStatus('ç²¾ç¡®å®šä½å¤±è´¥ï¼Œä½¿ç”¨IPå®šä½...', 'warning');
            
            AMap.plugin('AMap.CitySearch', () => {
                const citySearch = new AMap.CitySearch();
                citySearch.getLocalCity((status, result) => {
                    if (status === 'complete' && result.city) {
                        // ä½¿ç”¨åŸå¸‚ä¸­å¿ƒ
                        myLocation = result.center;
                        
                        // åˆ›å»ºæ ‡è®°
                        currentMarker = new AMap.Marker({
                            position: myLocation,
                            map: map,
                            title: 'å¤§è‡´ä½ç½®',
                            content: '<div style="background:#faad14;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>'
                        });
                        
                        map.setCenter(myLocation);
                        map.setZoom(12);
                        
                        document.getElementById('nav-btn').disabled = false;
                        updateStatus(`ğŸ“ IPå®šä½ï¼š${result.city}ï¼ˆç²¾åº¦è¾ƒä½ï¼‰`, 'success');
                    } else {
                        // æœ€ç»ˆåå¤‡ï¼šä½¿ç”¨é»˜è®¤ä½ç½®
                        myLocation = [116.397428, 39.90923];
                        map.setCenter(myLocation);
                        document.getElementById('nav-btn').disabled = false;
                        updateStatus('âš ï¸ ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆåŒ—äº¬ï¼‰', 'warning');
                    }
                });
            });
        }
        
        // å¼€å§‹å¯¼èˆª
        function startNavigation() {
            if (!myLocation) {
                updateStatus('è¯·å…ˆè·å–ä½ç½®', 'error');
                return;
            }
            
            const dest = document.getElementById('dest-input').value.trim();
            if (!dest) {
                updateStatus('è¯·è¾“å…¥ç›®çš„åœ°', 'error');
                return;
            }
            
            const btn = document.getElementById('nav-btn');
            btn.disabled = true;
            btn.textContent = 'è§„åˆ’ä¸­...';
            
            updateStatus('æ­£åœ¨è§„åˆ’è·¯çº¿...', 'info');
            
            // æ¸…é™¤æ—§ç›®çš„åœ°æ ‡è®°
            if (destMarker) {
                map.remove(destMarker);
            }
            
            // åœ°ç†ç¼–ç 
            const geocoder = new AMap.Geocoder();
            geocoder.getLocation(dest, (status, result) => {
                if (status === 'complete' && result.geocodes.length > 0) {
                    const destLoc = result.geocodes[0].location;
                    const destName = result.geocodes[0].formattedAddress;
                    
                    // æ·»åŠ ç›®çš„åœ°æ ‡è®°
                    destMarker = new AMap.Marker({
                        position: destLoc,
                        map: map,
                        title: destName,
                        content: '<div style="background:#f5222d;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>'
                    });
                    
                    // è·¯çº¿è§„åˆ’
                    const driving = new AMap.Driving({
                        map: map,
                        policy: AMap.DrivingPolicy.LEAST_TIME,
                        showTraffic: true,
                        hideMarkers: true
                    });
                    
                    driving.search(myLocation, destLoc, (status, result) => {
                        btn.disabled = false;
                        btn.textContent = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                        
                        if (status === 'complete') {
                            const route = result.routes[0];
                            const time = Math.ceil(route.time / 60);
                            const distance = (route.distance / 1000).toFixed(1);
                            
                            map.setFitView();
                            updateStatus(`âœ… å¯¼èˆªè§„åˆ’å®Œæˆï¼<br>ğŸ“ ${destName}<br>ğŸ“ è·ç¦»ï¼š${distance}å…¬é‡Œ<br>â±ï¸ æ—¶é—´ï¼š${time}åˆ†é’Ÿ`, 'success');
                        } else {
                            updateStatus('è·¯çº¿è§„åˆ’å¤±è´¥', 'error');
                        }
                    });
                } else {
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                    updateStatus('æ‰¾ä¸åˆ°ç›®çš„åœ°', 'error');
                }
            });
        }
        
        // æ¸…é™¤æ‰€æœ‰
        function clearAll() {
            if (map) {
                map.clearMap();
                currentMarker = null;
                destMarker = null;
                myLocation = null;
                document.getElementById('dest-input').value = '';
                document.getElementById('nav-btn').disabled = true;
                updateStatus('å·²æ¸…é™¤æ‰€æœ‰å†…å®¹', 'info');
            }
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, type) {
            const status = document.getElementById('status');
            status.innerHTML = text;
            
            // è®¾ç½®é¢œè‰²
            if (type === 'success') {
                status.style.color = '#52c41a';
                status.style.background = '#f6ffed';
            } else if (type === 'error') {
                status.style.color = '#ff4d4f';
                status.style.background = '#fff2f0';
            } else if (type === 'warning') {
                status.style.color = '#faad14';
                status.style.background = '#fffbe6';
            } else {
                status.style.color = '#1890ff';
                status.style.background = '#e6f7ff';
            }
        }
        
        // æµ‹è¯•å‡½æ•° - å¯ä»¥ç›´æ¥åœ¨æ§åˆ¶å°è°ƒç”¨
        window.testLocation = function() {
            console.log('æµ‹è¯•å®šä½åŠŸèƒ½...');
            getLocation();
        };
        
        window.testNavigation = function(dest) {
            if (dest) {
                document.getElementById('dest-input').value = dest;
            }
            startNavigation();
        };
    </script>
    
    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <script>
        console.log('========================================');
        console.log('æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿ');
        console.log('é«˜å¾·Key: 977b6123358698744cd4f2a96e219145');
        console.log('æµ‹è¯•åŠŸèƒ½:');
        console.log('1. testLocation() - æµ‹è¯•å®šä½');
        console.log('2. testNavigation("å¤©å®‰é—¨") - æµ‹è¯•å¯¼èˆª');
        console.log('========================================');
    </script>
</body>
</html>
