<!DOCTYPE HTML>
<html>
<head>
<meta name="viewport" content="width=device-width initial-scale=1.0 maximum-scale=1.0 user-scalable=0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>æ™ºèƒ½å¤´ç›”3Då¯¼èˆªç³»ç»Ÿ</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft Yahei", sans-serif;
    }
    
    body, html { 
        width: 100%;
        height: 100%;
        background: #f5f5f5;
    }
    
    /* ç™»å½•ç•Œé¢ */
    .login-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .login-box {
        background: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        width: 350px;
        text-align: center;
    }
    
    .login-box h2 {
        color: #333;
        margin-bottom: 30px;
        font-size: 24px;
    }
    
    .login-input {
        width: 100%;
        height: 45px;
        margin: 15px 0;
        padding: 0 15px;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 16px;
        outline: none;
    }
    
    .login-input:focus {
        border-color: #667eea;
    }
    
    .login-btn {
        width: 100%;
        height: 45px;
        background: linear-gradient(to right, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
    }
    
    .login-btn:hover {
        opacity: 0.9;
    }
    
    /* ä¸»ç•Œé¢ */
    .main-container {
        width: 100%;
        height: 100%;
        display: none;
    }
    
    /* é¡¶éƒ¨æ§åˆ¶æ  */
    .top-controls {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 999;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .top-controls h1 {
        color: #1890ff;
        font-size: 18px;
    }
    
    .control-buttons {
        display: flex;
        gap: 10px;
    }
    
    .control-btn {
        padding: 8px 20px;
        background: #1890ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .control-btn.logout {
        background: #ff4d4f;
    }
    
    .control-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    /* ä¾§è¾¹æ§åˆ¶é¢æ¿ */
    .side-panel {
        position: fixed;
        left: 20px;
        top: 80px;
        width: 300px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        z-index: 998;
    }
    
    .panel-section {
        margin-bottom: 20px;
    }
    
    .panel-section h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 16px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 5px;
    }
    
    .status-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .status-value {
        font-weight: bold;
    }
    
    .status-good { color: #52c41a; }
    .status-warning { color: #faad14; }
    .status-danger { color: #ff4d4f; }
    
    /* å¯¼èˆªè¾“å…¥ */
    .nav-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    #dest-input {
        flex: 1;
        height: 40px;
        padding: 0 15px;
        border: 1px solid #d9d9d9;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .nav-btn {
        width: 100%;
        height: 40px;
        background: #1890ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .nav-btn.clear {
        background: #ff4d4f;
    }
    
    /* çŠ¶æ€æç¤º */
    #status-tip {
        padding: 10px;
        background: #f6ffed;
        border: 1px solid #b7eb8f;
        border-radius: 5px;
        font-size: 14px;
        margin-top: 15px;
    }
    
    /* åœ°å›¾å®¹å™¨ */
    #map-container {
        width: 100%;
        height: 100%;
    }
</style>
<!-- é«˜å¾·åœ°å›¾API - ä½¿ç”¨æ‚¨çš„Keyå’Œå¿…è¦æ’ä»¶ -->
<script language="javascript" src="//webapi.amap.com/maps?v=2.0&key=977b6123358698744cd4f2a96e219145&plugin=AMap.ControlBar,AMap.ToolBar,AMap.Geolocation,AMap.Geocoder,AMap.Driving,AMap.Marker,AMap.Polyline"></script>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h2>ğŸ” æ™ºèƒ½å¤´ç›”ç³»ç»Ÿç™»å½•</h2>
            <input type="text" class="login-input" id="username" placeholder="ç”¨æˆ·å" value="admin">
            <input type="password" class="login-input" id="password" placeholder="å¯†ç " value="123456">
            <button class="login-btn" onclick="login()">ç™»å½•ç³»ç»Ÿ</button>
            <p style="margin-top: 15px; color: #666; font-size: 12px;">
                æ¼”ç¤ºè´¦å·ï¼šadmin / 123456
            </p>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main-container" id="mainPage">
        <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
        <div class="top-controls">
            <h1>ğŸï¸ æ™ºèƒ½å¤´ç›”3Då¯¼èˆªç›‘æ§ç³»ç»Ÿ</h1>
            <div class="control-buttons">
                <button class="control-btn" onclick="getMyLocation()">ğŸ“ å®šä½</button>
                <button class="control-btn logout" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
        
        <!-- ä¾§è¾¹æ§åˆ¶é¢æ¿ -->
        <div class="side-panel">
            <!-- è®¾å¤‡çŠ¶æ€ -->
            <div class="panel-section">
                <h3>ğŸ“Š è®¾å¤‡çŠ¶æ€</h3>
                <div class="status-item">
                    <span>GPSä¿¡å·ï¼š</span>
                    <span id="gps-signal" class="status-value status-good">å¼º</span>
                </div>
                <div class="status-item">
                    <span>ç”µæ± ç”µé‡ï¼š</span>
                    <span id="battery" class="status-value status-good">95%</span>
                </div>
                <div class="status-item">
                    <span>å¤´ç›”çŠ¶æ€ï¼š</span>
                    <span id="helmet-status" class="status-value status-good">å·²ä½©æˆ´</span>
                </div>
                <div class="status-item">
                    <span>ç¢°æ’æ£€æµ‹ï¼š</span>
                    <span id="crash-detect" class="status-value status-good">æ­£å¸¸</span>
                </div>
            </div>
            
            <!-- å¯¼èˆªæ§åˆ¶ -->
            <div class="panel-section">
                <h3>ğŸ§­ å®æ—¶å¯¼èˆª</h3>
                <div class="nav-input-group">
                    <input type="text" id="dest-input" placeholder="è¾“å…¥ç›®çš„åœ°">
                </div>
                <button class="nav-btn" onclick="startNavigation()" id="nav-btn">ğŸš€ å¼€å§‹å¯¼èˆª</button>
                <button class="nav-btn clear" onclick="clearNavigation()">ğŸ—‘ï¸ æ¸…é™¤è·¯çº¿</button>
                
                <!-- çŠ¶æ€æç¤º -->
                <div id="status-tip">
                    ğŸ‘‹ æ¬¢è¿ä½¿ç”¨3Då¯¼èˆªç³»ç»Ÿ
                </div>
            </div>
        </div>
        
        <!-- 3Dåœ°å›¾å®¹å™¨ -->
        <div id="map-container"></div>
    </div>

<script language="javascript">
    // å…¨å±€å˜é‡
    let map = null;
    let myLocation = null;
    let currentMarker = null;
    let destinationMarker = null;
    let currentRoute = null;
    let geolocation = null;
    
    // é¡µé¢åŠ è½½
    window.onload = function() {
        checkLoginStatus();
    };
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkLoginStatus() {
        const isLogin = localStorage.getItem('helmet_3d_login');
        if (isLogin === 'true') {
            showMainPage();
        } else {
            showLoginPage();
        }
    }
    
    // æ˜¾ç¤ºç™»å½•é¡µ
    function showLoginPage() {
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('mainPage').style.display = 'none';
    }
    
    // æ˜¾ç¤ºä¸»é¡µé¢
    function showMainPage() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainPage').style.display = 'block';
        
        // å»¶è¿Ÿåˆå§‹åŒ–åœ°å›¾
        setTimeout(init3DMap, 100);
        
        // å¼€å§‹æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®æ›´æ–°
        startDeviceSimulation();
    }
    
    // ç™»å½•
    function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        
        // ç®€å•éªŒè¯
        if (username === 'admin' && password === '123456') {
            localStorage.setItem('helmet_3d_login', 'true');
            showMainPage();
            updateStatus('âœ… ç™»å½•æˆåŠŸï¼æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å¤´ç›”3Då¯¼èˆªç³»ç»Ÿ', 'success');
        } else {
            updateStatus('âŒ ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
        }
    }
    
    // é€€å‡º
    function logout() {
        localStorage.removeItem('helmet_3d_login');
        showLoginPage();
    }
    
    // åˆå§‹åŒ–3Dåœ°å›¾
    function init3DMap() {
        try {
            map = new AMap.Map('map-container', {
                rotateEnable: true,      // å¼€å¯æ—‹è½¬
                pitchEnable: true,       // å¼€å¯ä¿¯ä»°
                zoom: 17,                // ç¼©æ”¾çº§åˆ«
                pitch: 50,               // ä¿¯ä»°è§’åº¦
                rotation: -15,           // æ—‹è½¬è§’åº¦
                viewMode: '3D',          // å¼€å¯3Dè§†å›¾
                zooms: [3, 20],          // ç¼©æ”¾èŒƒå›´
                center: [116.333926, 39.997245], // åŒ—äº¬ä¸­å¿ƒ
                resizeEnable: true
            });
            
            // æ·»åŠ æ§åˆ¶æ 
            var controlBar = new AMap.ControlBar({
                position: {
                    right: '20px',
                    top: '100px'
                }
            });
            controlBar.addTo(map);
            
            // æ·»åŠ å·¥å…·æ 
            var toolBar = new AMap.ToolBar({
                position: {
                    right: '20px',
                    top: '200px'
                }
            });
            toolBar.addTo(map);
            
            updateStatus('ğŸ—ºï¸ 3Dåœ°å›¾åˆå§‹åŒ–å®Œæˆï¼', 'success');
            
        } catch (error) {
            console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
            updateStatus('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
        }
    }
    
    // è·å–æˆ‘çš„ä½ç½®
    function getMyLocation() {
        if (!map) {
            updateStatus('âš ï¸ åœ°å›¾æœªå°±ç»ª', 'warning');
            return;
        }
        
        updateStatus('ğŸ” æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...', 'info');
        
        // åˆ›å»ºå®šä½å®ä¾‹
        geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000,
            showButton: false
        });
        
        map.addControl(geolocation);
        
        geolocation.getCurrentPosition(function(status, result) {
            if (status === 'complete') {
                onLocationSuccess(result);
            } else {
                onLocationError(result);
            }
        });
    }
    
    // å®šä½æˆåŠŸ
    function onLocationSuccess(result) {
        myLocation = result.position;
        
        // æ¸…é™¤æ—§æ ‡è®°
        if (currentMarker) {
            map.remove(currentMarker);
        }
        
        // åˆ›å»º3Dæ ‡è®°ï¼ˆå½“å‰ä½ç½®ï¼‰
        currentMarker = new AMap.Marker({
            position: myLocation,
            map: map,
            title: 'æˆ‘çš„ä½ç½®',
            content: createMarkerHTML('#1890ff', 'ğŸ“')
        });
        
        // ç§»åŠ¨åˆ°ä½ç½®ï¼ˆ3Dè§†è§’ï¼‰
        map.setCenter(myLocation);
        map.setZoom(17);
        map.setPitch(50);
        map.setRotation(-15);
        
        // æ›´æ–°çŠ¶æ€
        const address = result.addressComponent;
        const locationText = address ? `${address.city || ''}${address.district || ''}` : 'å½“å‰ä½ç½®';
        
        updateStatus(`âœ… å®šä½æˆåŠŸï¼ä½ç½®ï¼š${locationText}`, 'success');
        
        // æ›´æ–°GPSçŠ¶æ€
        updateDeviceStatus('gps-signal', 'å¼º', 'status-good');
        
        // å¯ç”¨å¯¼èˆªæŒ‰é’®
        document.getElementById('nav-btn').disabled = false;
    }
    
    // åˆ›å»ºæ ‡è®°HTML
    function createMarkerHTML(color, icon) {
        return `
            <div style="
                background: ${color};
                width: 30px;
                height: 30px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                color: white;
            ">
                ${icon}
            </div>
        `;
    }
    
    // å®šä½å¤±è´¥
    function onLocationError(error) {
        console.error('å®šä½å¤±è´¥:', error);
        
        updateStatus('âš ï¸ ç²¾ç¡®å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®', 'warning');
        
        // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰
        myLocation = [116.397428, 39.90923];
        
        // åˆ›å»ºæ ‡è®°
        currentMarker = new AMap.Marker({
            position: myLocation,
            map: map,
            title: 'é»˜è®¤ä½ç½®',
            content: createMarkerHTML('#faad14', 'ğŸ“')
        });
        
        map.setCenter(myLocation);
        map.setZoom(14);
        
        document.getElementById('nav-btn').disabled = false;
        updateDeviceStatus('gps-signal', 'å¼±', 'status-warning');
    }
    
    // å¼€å§‹å¯¼èˆª
    function startNavigation() {
        if (!myLocation) {
            updateStatus('âš ï¸ è¯·å…ˆè·å–å½“å‰ä½ç½®', 'warning');
            return;
        }
        
        const dest = document.getElementById('dest-input').value.trim();
        if (!dest) {
            updateStatus('âš ï¸ è¯·è¾“å…¥ç›®çš„åœ°', 'warning');
            return;
        }
        
        updateStatus('ğŸ—ºï¸ æ­£åœ¨è§„åˆ’è·¯çº¿...', 'info');
        
        // æ¸…é™¤æ—§è·¯çº¿å’Œç›®çš„åœ°æ ‡è®°
        if (destinationMarker) {
            map.remove(destinationMarker);
        }
        if (currentRoute) {
            map.remove(currentRoute);
        }
        
        // åœ°ç†ç¼–ç ï¼ˆåœ°å€è½¬åæ ‡ï¼‰
        const geocoder = new AMap.Geocoder();
        geocoder.getLocation(dest, function(status, result) {
            if (status === 'complete' && result.geocodes.length > 0) {
                const destLoc = result.geocodes[0].location;
                const destName = result.geocodes[0].formattedAddress;
                
                // åˆ›å»ºç›®çš„åœ°æ ‡è®°
                destinationMarker = new AMap.Marker({
                    position: destLoc,
                    map: map,
                    title: destName,
                    content: createMarkerHTML('#f5222d', 'ğŸ')
                });
                
                // è·¯çº¿è§„åˆ’
                const driving = new AMap.Driving({
                    map: map,
                    policy: AMap.DrivingPolicy.LEAST_TIME,
                    showTraffic: true,
                    hideMarkers: true
                });
                
                driving.search(myLocation, destLoc, function(status, result) {
                    if (status === 'complete') {
                        const route = result.routes[0];
                        const time = Math.ceil(route.time / 60);
                        const distance = (route.distance / 1000).toFixed(1);
                        
                        // è°ƒæ•´3Dè§†è§’
                        map.setFitView();
                        map.setPitch(50);
                        map.setRotation(-15);
                        
                        updateStatus(`âœ… å¯¼èˆªè§„åˆ’å®Œæˆï¼<br>ğŸ“ ${destName}<br>ğŸ“ ${distance}å…¬é‡Œ | â±ï¸ ${time}åˆ†é’Ÿ`, 'success');
                    } else {
                        updateStatus('âŒ è·¯çº¿è§„åˆ’å¤±è´¥', 'error');
                    }
                });
                
            } else {
                updateStatus('âŒ æ‰¾ä¸åˆ°ç›®çš„åœ°ï¼Œè¯·æ£€æŸ¥åœ°å€', 'error');
            }
        });
    }
    
    // æ¸…é™¤å¯¼èˆª
    function clearNavigation() {
        if (destinationMarker) {
            map.remove(destinationMarker);
            destinationMarker = null;
        }
        if (currentRoute) {
            map.remove(currentRoute);
            currentRoute = null;
        }
        document.getElementById('dest-input').value = '';
        updateStatus('ğŸ—‘ï¸ å·²æ¸…é™¤è·¯çº¿å’Œæ ‡è®°', 'info');
    }
    
    // æ›´æ–°çŠ¶æ€æç¤º
    function updateStatus(text, type) {
        const statusEl = document.getElementById('status-tip');
        statusEl.innerHTML = text;
        
        // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
        switch(type) {
            case 'success':
                statusEl.style.background = '#f6ffed';
                statusEl.style.border = '1px solid #b7eb8f';
                statusEl.style.color = '#52c41a';
                break;
            case 'error':
                statusEl.style.background = '#fff2f0';
                statusEl.style.border = '1px solid #ffccc7';
                statusEl.style.color = '#ff4d4f';
                break;
            case 'warning':
                statusEl.style.background = '#fffbe6';
                statusEl.style.border = '1px solid #ffe58f';
                statusEl.style.color = '#faad14';
                break;
            case 'info':
                statusEl.style.background = '#e6f7ff';
                statusEl.style.border = '1px solid #91d5ff';
                statusEl.style.color = '#1890ff';
                break;
        }
    }
    
    // æ›´æ–°è®¾å¤‡çŠ¶æ€
    function updateDeviceStatus(elementId, text, statusClass) {
        const element = document.getElementById(elementId);
        element.textContent = text;
        element.className = 'status-value ' + statusClass;
    }
    
    // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®æ›´æ–°
    function startDeviceSimulation() {
        setInterval(() => {
            // æ¨¡æ‹Ÿç”µæ± ç”µé‡å˜åŒ–
            const battery = 80 + Math.floor(Math.random() * 20);
            updateDeviceStatus('battery', battery + '%', 
                battery > 60 ? 'status-good' : 
                battery > 30 ? 'status-warning' : 'status-danger');
            
            // æ¨¡æ‹Ÿæ¸©åº¦å˜åŒ–
            const temp = 25 + Math.floor(Math.random() * 15);
            
            // éšæœºæ¨¡æ‹Ÿç¢°æ’æ£€æµ‹
            if (Math.random() > 0.95) {
                updateDeviceStatus('crash-detect', 'è­¦å‘Š', 'status-danger');
                updateStatus('ğŸš¨ æ£€æµ‹åˆ°å¼‚å¸¸éœ‡åŠ¨ï¼è¯·æ£€æŸ¥å®‰å…¨çŠ¶å†µ', 'error');
            } else {
                updateDeviceStatus('crash-detect', 'æ­£å¸¸', 'status-good');
            }
            
        }, 3000);
    }
</script>
</body>
</html>
