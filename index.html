<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>å®Œæ•´å¯¼èˆªç³»ç»Ÿ</title>
    <style>
        #map { width:100%; height:500px; border:2px solid #1890ff; }
        .controls { margin:20px 0; }
        button { padding:12px 24px; margin:5px; background:#1890ff; color:white; border:none; }
        #status { padding:15px; margin:10px 0; }
    </style>
</head>
<body>
    <h1>ğŸï¸ æ™ºèƒ½å¤´ç›”å¯¼èˆª - åˆ†å¼€åŠ è½½ç‰ˆæœ¬</h1>
    
    <div class="controls">
        <input type="text" id="dest" placeholder="ç›®çš„åœ°" style="padding:10px; width:250px;">
        <button onclick="step1_getLocation()" id="btn1">1. è·å–ä½ç½®</button>
        <button onclick="step2_searchDest()" id="btn2" disabled>2. æœç´¢ç›®çš„åœ°</button>
        <button onclick="step3_startNav()" id="btn3" disabled>3. å¼€å§‹å¯¼èˆª</button>
    </div>
    
    <div id="map"></div>
    <div id="status">ç¬¬ä¸€æ­¥ï¼šç‚¹å‡»"è·å–ä½ç½®"</div>
    
    <!-- åªåŠ è½½åŸºç¡€åœ°å›¾ -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=977b6123358698744cd4f2a96e219145"></script>
    
    <script>
        let map = null;
        let myPos = null;
        let destPos = null;
        let myMarker = null;
        let destMarker = null;
        let geocoder = null;
        let driving = null;
        
        // åˆå§‹åŒ–
        function init() {
            map = new AMap.Map('map', {
                zoom: 14,
                center: [116.397428, 39.90923],
                resizeEnable: true
            });
            console.log('âœ… åŸºç¡€åœ°å›¾åŠ è½½å®Œæˆ');
        }
        
        // ç¬¬ä¸€æ­¥ï¼šè·å–ä½ç½®ï¼ˆåªç”¨æµè§ˆå™¨å®šä½ï¼‰
        function step1_getLocation() {
            document.getElementById('status').innerHTML = 'æ­£åœ¨è·å–ä½ç½®...';
            document.getElementById('btn1').disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    myPos = [lng, lat];
                    
                    // æ˜¾ç¤ºåœ¨åœ°å›¾ä¸Š
                    if (myMarker) map.remove(myMarker);
                    myMarker = new AMap.Marker({
                        position: myPos,
                        map: map
                    });
                    
                    map.setCenter(myPos);
                    map.setZoom(16);
                    
                    document.getElementById('status').innerHTML = 
                        'âœ… ä½ç½®è·å–æˆåŠŸ<br>' +
                        'çº¬åº¦: ' + lat.toFixed(6) + '<br>' +
                        'ç»åº¦: ' + lng.toFixed(6);
                    
                    document.getElementById('btn2').disabled = false;
                },
                function(err) {
                    document.getElementById('status').innerHTML = 
                        'âŒ å®šä½å¤±è´¥: ' + err.message;
                    document.getElementById('btn1').disabled = false;
                }
            );
        }
        
        // ç¬¬äºŒæ­¥ï¼šæœç´¢ç›®çš„åœ°ï¼ˆåŠ¨æ€åŠ è½½åœ°ç†ç¼–ç æ’ä»¶ï¼‰
        function step2_searchDest() {
            const dest = document.getElementById('dest').value.trim();
            if (!dest) {
                alert('è¯·è¾“å…¥ç›®çš„åœ°');
                return;
            }
            
            document.getElementById('status').innerHTML = 'æ­£åœ¨æœç´¢ç›®çš„åœ°...';
            document.getElementById('btn2').disabled = true;
            
            // åŠ¨æ€åŠ è½½åœ°ç†ç¼–ç æ’ä»¶
            AMap.plugin('AMap.Geocoder', function() {
                geocoder = new AMap.Geocoder();
                
                geocoder.getLocation(dest, function(status, result) {
                    if (status === 'complete' && result.geocodes.length > 0) {
                        destPos = result.geocodes[0].location;
                        
                        // æ·»åŠ ç›®çš„åœ°æ ‡è®°
                        if (destMarker) map.remove(destMarker);
                        destMarker = new AMap.Marker({
                            position: destPos,
                            map: map,
                            content: '<div style="background:red;width:20px;height:20px;border-radius:50%;"></div>'
                        });
                        
                        document.getElementById('status').innerHTML = 
                            'âœ… æ‰¾åˆ°ç›®çš„åœ°<br>' +
                            result.geocodes[0].formattedAddress;
                        
                        document.getElementById('btn3').disabled = false;
                    } else {
                        document.getElementById('status').innerHTML = 'æ‰¾ä¸åˆ°ç›®çš„åœ°';
                        document.getElementById('btn2').disabled = false;
                    }
                });
            });
        }
        
        // ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹å¯¼èˆªï¼ˆåŠ¨æ€åŠ è½½å¯¼èˆªæ’ä»¶ï¼‰
        function step3_startNav() {
            if (!myPos || !destPos) return;
            
            document.getElementById('status').innerHTML = 'æ­£åœ¨è§„åˆ’è·¯çº¿...';
            document.getElementById('btn3').disabled = true;
            
            // åŠ¨æ€åŠ è½½é©¾è½¦å¯¼èˆªæ’ä»¶
            AMap.plugin('AMap.Driving', function() {
                driving = new AMap.Driving({
                    map: map,
                    policy: AMap.DrivingPolicy.LEAST_TIME
                });
                
                driving.search(myPos, destPos, function(status, result) {
                    if (status === 'complete') {
                        map.setFitView();
                        document.getElementById('status').innerHTML = 'âœ… å¯¼èˆªè·¯çº¿è§„åˆ’å®Œæˆï¼';
                    } else {
                        document.getElementById('status').innerHTML = 'è·¯çº¿è§„åˆ’å¤±è´¥';
                        document.getElementById('btn3').disabled = false;
                    }
                });
            });
        }
        
        // åˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>
