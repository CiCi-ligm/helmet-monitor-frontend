<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤´ç›”ç›‘æ§å¯¼èˆªç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        
        body, html { 
            width: 100%;
            height: 100%;
            background: #f5f5f5;
        }
        
        /* ç™»å½•ç•Œé¢ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 350px;
            text-align: center;
        }
        
        .login-box h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .login-input {
            width: 100%;
            height: 45px;
            margin: 15px 0;
            padding: 0 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }
        
        .login-input:focus {
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            height: 45px;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            opacity: 0.9;
        }
        
        /* ä¸»ç•Œé¢ */
        .main-container {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .top-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .top-controls h1 {
            color: #1890ff;
            font-size: 18px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            padding: 8px 20px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .control-btn.logout {
            background: #ff4d4f;
        }
        
        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* ä¾§è¾¹æ§åˆ¶é¢æ¿ */
        .side-panel {
            position: fixed;
            left: 20px;
            top: 80px;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 998;
        }
        
        .panel-section {
            margin-bottom: 20px;
        }
        
        .panel-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .status-value {
            font-weight: bold;
        }
        
        .status-good { color: #52c41a; }
        .status-warning { color: #faad14; }
        .status-danger { color: #ff4d4f; }
        
        /* å¯¼èˆªè¾“å…¥ */
        .nav-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #dest-input {
            flex: 1;
            height: 40px;
            padding: 0 15px;
            border: 1px solid #d9d9d9;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .nav-btn {
            width: 100%;
            height: 40px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .nav-btn.clear {
            background: #ff4d4f;
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* çŠ¶æ€æç¤º */
        #status-tip {
            padding: 10px;
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 5px;
            font-size: 14px;
            margin-top: 15px;
            min-height: 60px;
        }
        
        /* åœ°å›¾å®¹å™¨ */
        #map-container {
            width: 100%;
            height: 100%;
        }
        
        /* å®šä½æƒé™æç¤º */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .permission-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            text-align: center;
        }
        
        .permission-box h3 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .permission-btn {
            padding: 10px 30px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* è®¾å¤‡è¿æ¥çŠ¶æ€ */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 997;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-connected {
            background: #52c41a;
            animation: pulse 2s infinite;
        }
        
        .status-disconnected {
            background: #ff4d4f;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* æ¨¡æ‹Ÿæ§åˆ¶é¢æ¿ */
        .simulation-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 997;
        }
        
        .sim-btn {
            padding: 8px 15px;
            background: #722ed1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .sim-btn:hover {
            opacity: 0.8;
        }
    </style>
    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=977b6123358698744cd4f2a96e219145&plugin=AMap.Geolocation,AMap.Geocoder,AMap.Driving,AMap.Marker,AMap.Polyline,AMap.CitySearch"></script>
</head>
<body>
    <!-- å®šä½æƒé™æç¤º -->
    <div class="permission-modal" id="permissionModal">
        <div class="permission-box">
            <h3>ğŸ“ éœ€è¦ä½ç½®æƒé™</h3>
            <p>æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿéœ€è¦è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯</p>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œç„¶ååœ¨æµè§ˆå™¨å¼¹å‡ºçš„æƒé™è¯·æ±‚ä¸­é€‰æ‹©"å…è®¸"
            </p>
            <button class="permission-btn" onclick="requestLocationPermission()">å…è®¸å®šä½</button>
            <button class="permission-btn" onclick="useSimulationMode()" style="background: #722ed1; margin-top: 10px;">ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼</button>
        </div>
    </div>

    <!-- ç™»å½•ç•Œé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h2>ğŸ” æ™ºèƒ½å¤´ç›”ç³»ç»Ÿç™»å½•</h2>
            <input type="text" class="login-input" id="username" placeholder="ç”¨æˆ·å" value="admin">
            <input type="password" class="login-input" id="password" placeholder="å¯†ç " value="123456">
            <button class="login-btn" onclick="login()">ç™»å½•ç³»ç»Ÿ</button>
            <p style="margin-top: 15px; color: #666; font-size: 12px;">
                æ¼”ç¤ºè´¦å·ï¼šadmin / 123456
            </p>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main-container" id="mainPage">
        <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
        <div class="top-controls">
            <h1>ğŸï¸ æ™ºèƒ½å¤´ç›”ç›‘æ§å¯¼èˆªç³»ç»Ÿ</h1>
            <div class="control-buttons">
                <button class="control-btn" onclick="getMyLocation()" id="loc-btn">ğŸ“ è·å–ä½ç½®</button>
                <button class="control-btn logout" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
        
        <!-- ä¾§è¾¹æ§åˆ¶é¢æ¿ -->
        <div class="side-panel">
            <!-- è®¾å¤‡çŠ¶æ€ -->
            <div class="panel-section">
                <h3>ğŸ“Š è®¾å¤‡çŠ¶æ€</h3>
                <div class="status-item">
                    <span>GPSä¿¡å·ï¼š</span>
                    <span id="gps-signal" class="status-value status-warning">æœªè¿æ¥</span>
                </div>
                <div class="status-item">
                    <span>ç”µæ± ç”µé‡ï¼š</span>
                    <span id="battery" class="status-value status-good">95%</span>
                </div>
                <div class="status-item">
                    <span>å¤´ç›”çŠ¶æ€ï¼š</span>
                    <span id="helmet-status" class="status-value status-good">å·²ä½©æˆ´</span>
                </div>
                <div class="status-item">
                    <span>ç¢°æ’æ£€æµ‹ï¼š</span>
                    <span id="crash-detect" class="status-value status-good">æ­£å¸¸</span>
                </div>
                <div class="status-item">
                    <span>é€Ÿåº¦ï¼š</span>
                    <span id="speed" class="status-value">0 km/h</span>
                </div>
            </div>
            
            <!-- å¯¼èˆªæ§åˆ¶ -->
            <div class="panel-section">
                <h3>ğŸ§­ å®æ—¶å¯¼èˆª</h3>
                <div class="nav-input-group">
                    <input type="text" id="dest-input" placeholder="è¾“å…¥ç›®çš„åœ°ï¼Œå¦‚ï¼šå¤©å®‰é—¨">
                    <button class="nav-btn" onclick="searchDestination()">ğŸ”</button>
                </div>
                <button class="nav-btn" onclick="startNavigation()" id="nav-btn" disabled>ğŸš€ å¼€å§‹å¯¼èˆª</button>
                <button class="nav-btn clear" onclick="clearNavigation()">ğŸ—‘ï¸ æ¸…é™¤è·¯çº¿</button>
                
                <!-- çŠ¶æ€æç¤º -->
                <div id="status-tip">
                    ğŸ‘‹ ç™»å½•æˆåŠŸï¼è¯·å…ˆè·å–ä½ç½®æˆ–ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                </div>
            </div>
            
            <!-- å†å²è®°å½• -->
            <div class="panel-section">
                <h3>ğŸ“ å†å²è®°å½•</h3>
                <div id="history-list" style="font-size: 12px; color: #666;">
                    <p>æœ€è¿‘ä½ç½®ï¼šæœªè®°å½•</p>
                    <p>å¯¼èˆªæ¬¡æ•°ï¼š0</p>
                    <p>æ€»é‡Œç¨‹ï¼š0 km</p>
                </div>
            </div>
        </div>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="connection-status" id="connectionStatus">
            <div class="status-dot status-disconnected"></div>
            <span>è®¾å¤‡æœªè¿æ¥</span>
        </div>
        
        <!-- æ¨¡æ‹Ÿæ§åˆ¶é¢æ¿ -->
        <div class="simulation-controls">
            <button class="sim-btn" onclick="startSimulation()">â–¶ å¼€å§‹æ¨¡æ‹Ÿ</button>
            <button class="sim-btn" onclick="stopSimulation()">â¹ åœæ­¢æ¨¡æ‹Ÿ</button>
            <button class="sim-btn" onclick="simulateCrash()">ğŸ’¥ æ¨¡æ‹Ÿç¢°æ’</button>
            <button class="sim-btn" onclick="simulateSOS()">ğŸ†˜ æ¨¡æ‹Ÿæ±‚æ•‘</button>
        </div>
        
        <!-- åœ°å›¾å®¹å™¨ -->
        <div id="map-container"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let myLocation = null;
        let currentMarker = null;
        let destinationMarker = null;
        let currentRoute = null;
        let isLocationReady = false;
        let simulationInterval = null;
        let isSimulationMode = false;
        let pathIndex = 0;
        let ws = null;
        
        // æ¨¡æ‹Ÿè·¯å¾„ç‚¹ï¼ˆåŒ—äº¬å¤©å®‰é—¨å‘¨è¾¹ï¼‰
        const simulationPath = [
            [116.397428, 39.90923],   // å¤©å®‰é—¨
            [116.403865, 39.913685],  // æ•…å®«
            [116.415358, 39.908482],  // ç‹åºœäº•
            [116.406605, 39.921894],  // æ™¯å±±å…¬å›­
            [116.390214, 39.911861],  // å›½å®¶å¤§å‰§é™¢
            [116.397428, 39.90923]    // å›åˆ°èµ·ç‚¹
        ];
        
        // é¡µé¢åŠ è½½
        window.onload = function() {
            console.log('æ™ºèƒ½å¤´ç›”ç³»ç»Ÿåˆå§‹åŒ–...');
            checkLoginStatus();
            initWebSocket(); // åˆå§‹åŒ–WebSocketè¿æ¥
        };
        
        // åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆç”¨äºçœŸå®è®¾å¤‡è¿æ¥ï¼‰
        function initWebSocket() {
            // WebSocketæœåŠ¡å™¨åœ°å€ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
            const wsUrl = 'ws://' + window.location.hostname + ':8080/ws';
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleRealDeviceData(data);
                } catch (e) {
                    console.error('æ•°æ®è§£æé”™è¯¯:', e);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å…³é—­');
                updateConnectionStatus(false);
                // 5ç§’åé‡è¿
                setTimeout(initWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const dot = statusEl.querySelector('.status-dot');
            
            if (connected) {
                dot.className = 'status-dot status-connected';
                statusEl.querySelector('span').textContent = 'è®¾å¤‡å·²è¿æ¥';
            } else {
                dot.className = 'status-dot status-disconnected';
                statusEl.querySelector('span').textContent = 'è®¾å¤‡æœªè¿æ¥';
            }
        }
        
        // å¤„ç†çœŸå®è®¾å¤‡æ•°æ®
        function handleRealDeviceData(data) {
            console.log('æ”¶åˆ°è®¾å¤‡æ•°æ®:', data);
            
            if (data.type === 'location') {
                // æ›´æ–°ä½ç½®
                updateRealLocation(data);
            } else if (data.type === 'sensor') {
                // æ›´æ–°ä¼ æ„Ÿå™¨æ•°æ®
                updateRealSensorData(data);
            } else if (data.type === 'status') {
                // æ›´æ–°è®¾å¤‡çŠ¶æ€
                updateDeviceStatus(data);
            }
        }
        
        // æ›´æ–°çœŸå®ä½ç½®
        function updateRealLocation(locData) {
            const lng = locData.longitude;
            const lat = locData.latitude;
            
            myLocation = [lng, lat];
            isLocationReady = true;
            
            // æ›´æ–°æ ‡è®°
            if (!currentMarker) {
                currentMarker = new AMap.Marker({
                    position: myLocation,
                    map: map,
                    title: 'å½“å‰ä½ç½®',
                    content: createMarkerHTML('#1890ff', 'ğŸ“')
                });
            } else {
                currentMarker.setPosition(myLocation);
            }
            
            // ç§»åŠ¨åœ°å›¾
            if (map) {
                map.setCenter(myLocation);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('gps-signal').textContent = 'å¼º';
            document.getElementById('gps-signal').className = 'status-value status-good';
            
            document.getElementById('nav-btn').disabled = false;
            
            updateStatus(`âœ… è®¾å¤‡å®šä½æ›´æ–°: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
        }
        
        // æ›´æ–°çœŸå®ä¼ æ„Ÿå™¨æ•°æ®
        function updateRealSensorData(sensorData) {
            if (sensorData.battery !== undefined) {
                updateDeviceStatus('battery', sensorData.battery + '%', 
                    sensorData.battery > 30 ? 'status-good' : 
                    sensorData.battery > 15 ? 'status-warning' : 'status-danger');
            }
            
            if (sensorData.temperature !== undefined) {
                // æ¸©åº¦æ˜¾ç¤º
            }
            
            if (sensorData.speed !== undefined) {
                document.getElementById('speed').textContent = sensorData.speed + ' km/h';
            }
            
            if (sensorData.crash) {
                simulateCrash();
            }
            
            if (sensorData.sos) {
                simulateSOS();
            }
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const isLogin = localStorage.getItem('helmet_login');
            if (isLogin === 'true') {
                showMainPage();
            } else {
                showLoginPage();
            }
        }
        
        // æ˜¾ç¤ºç™»å½•é¡µ
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainPage').style.display = 'none';
        }
        
        // æ˜¾ç¤ºä¸»é¡µé¢
        function showMainPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            
            // åˆå§‹åŒ–åœ°å›¾
            initMap();
            
            // æ˜¾ç¤ºå®šä½æƒé™æç¤ºï¼ˆå»¶è¿Ÿæ˜¾ç¤ºï¼‰
            setTimeout(() => {
                checkAndShowPermissionTip();
            }, 1000);
            
            // å¼€å§‹è®¾å¤‡æ•°æ®æ¨¡æ‹Ÿæ›´æ–°
            startDeviceSimulation();
        }
        
        // æ£€æŸ¥å¹¶æ˜¾ç¤ºæƒé™æç¤º
        function checkAndShowPermissionTip() {
            // å¦‚æœå·²ç»æœ‰ä½ç½®äº†ï¼Œå°±ä¸æ˜¾ç¤ºæç¤º
            if (isLocationReady) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰å®šä½æƒé™
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
                    if (result.state === 'prompt') {
                        document.getElementById('permissionModal').style.display = 'flex';
                    }
                });
            } else {
                document.getElementById('permissionModal').style.display = 'flex';
            }
        }
        
        // è¯·æ±‚å®šä½æƒé™
        function requestLocationPermission() {
            document.getElementById('permissionModal').style.display = 'none';
            updateStatus('ğŸ” æ­£åœ¨è¯·æ±‚å®šä½æƒé™...', 'info');
            
            // ç›´æ¥è°ƒç”¨å®šä½
            getMyLocation();
        }
        
        // ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼
        function useSimulationMode() {
            document.getElementById('permissionModal').style.display = 'none';
            isSimulationMode = true;
            updateStatus('ğŸ® è¿›å…¥æ¨¡æ‹Ÿæ¼”ç¤ºæ¨¡å¼', 'success');
            
            // é»˜è®¤ä½ç½®
            myLocation = [116.397428, 39.90923];
            isLocationReady = true;
            
            // åˆ›å»ºé»˜è®¤æ ‡è®°
            if (map) {
                currentMarker = new AMap.Marker({
                    position: myLocation,
                    map: map,
                    title: 'æ¨¡æ‹Ÿä½ç½®',
                    content: createMarkerHTML('#722ed1', 'ğŸ“')
                });
                
                map.setCenter(myLocation);
                map.setZoom(16);
            }
            
            document.getElementById('nav-btn').disabled = false;
            document.getElementById('gps-signal').textContent = 'æ¨¡æ‹Ÿ';
            document.getElementById('gps-signal').className = 'status-value status-warning';
        }
        
        // ç™»å½•
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (username === 'admin' && password === '123456') {
                localStorage.setItem('helmet_login', 'true');
                showMainPage();
                updateStatus('âœ… ç™»å½•æˆåŠŸï¼æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å¤´ç›”ç³»ç»Ÿ', 'success');
            } else {
                updateStatus('âŒ ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
            }
        }
        
        // é€€å‡º
        function logout() {
            localStorage.removeItem('helmet_login');
            showLoginPage();
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            try {
                console.log('åˆå§‹åŒ–åœ°å›¾...');
                
                map = new AMap.Map('map-container', {
                    zoom: 14,
                    center: [116.397428, 39.90923], // åŒ—äº¬
                    resizeEnable: true
                });
                
                console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                updateStatus('ğŸ—ºï¸ åœ°å›¾åŠ è½½å®Œæˆï¼', 'success');
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // è·å–æˆ‘çš„ä½ç½® - åŒä¿é™©å®šä½
        function getMyLocation() {
            if (!map) {
                updateStatus('âš ï¸ åœ°å›¾æœªå°±ç»ªï¼Œè¯·ç¨å€™...', 'warning');
                return;
            }
            
            const btn = document.getElementById('loc-btn');
            btn.disabled = true;
            btn.textContent = 'å®šä½ä¸­...';
            
            updateStatus('ğŸ” æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...', 'info');
            
            // æ¸…é™¤æ—§æ ‡è®°
            if (currentMarker) {
                map.remove(currentMarker);
                currentMarker = null;
            }
            
            // æ–¹æ³•1ï¼šå…ˆå°è¯•æµè§ˆå™¨åŸç”Ÿå®šä½
            if (navigator.geolocation && !isSimulationMode) {
                console.log('å°è¯•æµè§ˆå™¨åŸç”Ÿå®šä½...');
                
                navigator.geolocation.getCurrentPosition(
                    // æˆåŠŸå›è°ƒ
                    function(position) {
                        console.log('æµè§ˆå™¨å®šä½æˆåŠŸ:', position);
                        handleLocationSuccess(
                            position.coords.longitude, 
                            position.coords.latitude, 
                            'æµè§ˆå™¨å®šä½'
                        );
                        btn.disabled = false;
                        btn.textContent = 'ğŸ“ è·å–ä½ç½®';
                    },
                    // å¤±è´¥å›è°ƒ
                    function(error) {
                        console.log('æµè§ˆå™¨å®šä½å¤±è´¥ï¼Œå°è¯•é«˜å¾·å®šä½:', error);
                        // æ–¹æ³•2ï¼šä½¿ç”¨é«˜å¾·å®šä½
                        useAmapGeolocation(btn);
                    },
                    // é…ç½®
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼æˆ–é«˜å¾·å®šä½');
                if (isSimulationMode) {
                    useSimulationMode();
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“ è·å–ä½ç½®';
                } else {
                    useAmapGeolocation(btn);
                }
            }
        }
        
        // ä½¿ç”¨é«˜å¾·å®šä½
        function useAmapGeolocation(btn) {
            console.log('ä½¿ç”¨é«˜å¾·åœ°å›¾å®šä½...');
            
            try {
                // åˆ›å»ºé«˜å¾·å®šä½å®ä¾‹
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0,
                    convert: true,
                    showButton: false,
                    panToLocation: true,
                    zoomToAccuracy: true
                });
                
                map.addControl(geolocation);
                
                geolocation.getCurrentPosition(function(status, result) {
                    console.log('é«˜å¾·å®šä½ç»“æœ:', status, result);
                    
                    if (status === 'complete') {
                        handleAmapLocationSuccess(result);
                    } else {
                        handleLocationError('é«˜å¾·å®šä½å¤±è´¥');
                        // å¦‚æœå¤±è´¥ï¼Œå¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                        useSimulationMode();
                    }
                    
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“ è·å–ä½ç½®';
                });
                
            } catch (error) {
                console.error('é«˜å¾·å®šä½å‡ºé”™:', error);
                handleLocationError('å®šä½æœåŠ¡å¼‚å¸¸');
                useSimulationMode();
                btn.disabled = false;
                btn.textContent = 'ğŸ“ è·å–ä½ç½®';
            }
        }
        
        // å¤„ç†æµè§ˆå™¨å®šä½æˆåŠŸ
        function handleLocationSuccess(lng, lat, source) {
            myLocation = [lng, lat];
            isLocationReady = true;
            
            // åˆ›å»ºæ ‡è®°
            currentMarker = new AMap.Marker({
                position: myLocation,
                map: map,
                title: source,
                content: createMarkerHTML('#1890ff', 'ğŸ“')
            });
            
            // ç§»åŠ¨åˆ°ä½ç½®
            map.setCenter(myLocation);
            map.setZoom(16);
            
            // å¯ç”¨å¯¼èˆªæŒ‰é’®
            document.getElementById('nav-btn').disabled = false;
            
            updateStatus(`âœ… ${source}æˆåŠŸï¼ä½ç½®å·²è·å–`, 'success');
            updateDeviceStatus('gps-signal', 'å¼º', 'status-good');
        }
        
        // å¤„ç†é«˜å¾·å®šä½æˆåŠŸ
        function handleAmapLocationSuccess(result) {
            myLocation = result.position;
            isLocationReady = true;
            
            // åˆ›å»ºæ ‡è®°
            currentMarker = new AMap.Marker({
                position: myLocation,
                map: map,
                title: 'é«˜å¾·å®šä½',
                content: createMarkerHTML('#1890ff', 'ğŸ“')
            });
            
            // ç§»åŠ¨åˆ°ä½ç½®
            map.setCenter(myLocation);
            map.setZoom(16);
            
            // å¯ç”¨å¯¼èˆªæŒ‰é’®
            document.getElementById('nav-btn').disabled = false;
            
            // æ˜¾ç¤ºåœ°å€ä¿¡æ¯
            const address = result.addressComponent || {};
            const locationText = address.city ? `${address.city}${address.district || ''}` : 'å½“å‰ä½ç½®';
            
            updateStatus(`âœ… é«˜å¾·å®šä½æˆåŠŸï¼ä½ç½®ï¼š${locationText}`, 'success');
            updateDeviceStatus('gps-signal', 'å¼º', 'status-good');
        }
        
        // å¤„ç†å®šä½é”™è¯¯
        function handleLocationError(errorMsg) {
            console.error(errorMsg);
            updateStatus('âš ï¸ ' + errorMsg, 'warning');
            updateDeviceStatus('gps-signal', 'å¼±', 'status-danger');
        }
        
        // åˆ›å»ºæ ‡è®°HTML
        function createMarkerHTML(color, icon) {
            return `
                <div style="
                    background: ${color};
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 16px;
                    color: white;
                    cursor: pointer;
                ">
                    ${icon}
                </div>
            `;
        }
        
        // æœç´¢ç›®çš„åœ°
        function searchDestination() {
            const dest = document.getElementById('dest-input').value.trim();
            if (!dest) return;
            
            updateStatus('ğŸ” æœç´¢ç›®çš„åœ°...', 'info');
            
            // ä½¿ç”¨é«˜å¾·åœ°ç†ç¼–ç 
            const geocoder = new AMap.Geocoder();
            geocoder.getLocation(dest, function(status, result) {
                if (status === 'complete' && result.geocodes.length > 0) {
                    const destLoc = result.geocodes[0].location;
                    const destName = result.geocodes[0].formattedAddress;
                    
                    // æ¸…é™¤æ—§çš„ç›®çš„åœ°æ ‡è®°
                    if (destinationMarker) {
                        map.remove(destinationMarker);
                    }
                    
                    // åˆ›å»ºç›®çš„åœ°æ ‡è®°
                    destinationMarker = new AMap.Marker({
                        position: destLoc,
                        map: map,
                        title: destName,
                        content: createMarkerHTML('#f5222d', 'ğŸ')
                    });
                    
                    // ç§»åŠ¨åˆ°ç›®çš„åœ°
                    map.setCenter(destLoc);
                    map.setZoom(15);
                    
                    updateStatus(`ğŸ“ æ‰¾åˆ°ç›®çš„åœ°ï¼š${destName}`, 'success');
                    
                    // å¦‚æœå·²ç»æœ‰å½“å‰ä½ç½®ï¼Œå¯ç”¨å¯¼èˆªæŒ‰é’®
                    if (isLocationReady) {
                        document.getElementById('nav-btn').disabled = false;
                    }
                } else {
                    updateStatus('âŒ æ‰¾ä¸åˆ°ç›®çš„åœ°ï¼Œè¯·æ£€æŸ¥åœ°å€', 'error');
                }
            });
        }
        
        // å¼€å§‹å¯¼èˆª
        function startNavigation() {
            if (!isLocationReady || !myLocation) {
                updateStatus('âš ï¸ è¯·å…ˆè·å–å½“å‰ä½ç½®', 'warning');
                return;
            }
            
            const dest = document.getElementById('dest-input').value.trim();
            if (!dest) {
                updateStatus('âš ï¸ è¯·è¾“å…¥ç›®çš„åœ°', 'warning');
                return;
            }
            
            updateStatus('ğŸ—ºï¸ æ­£åœ¨è§„åˆ’è·¯çº¿...', 'info');
            
            // æ¸…é™¤æ—§è·¯çº¿
            if (currentRoute) {
                map.remove(currentRoute);
            }
            
            // åœ°ç†ç¼–ç 
            const geocoder = new AMap.Geocoder();
            geocoder.getLocation(dest, function(status, result) {
                if (status === 'complete' && result.geocodes.length > 0) {
                    const destLoc = result.geocodes[0].location;
                    const destName = result.geocodes[0].formattedAddress;
                    
                    // åˆ›å»ºç›®çš„åœ°æ ‡è®°ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                    if (!destinationMarker) {
                        destinationMarker = new AMap.Marker({
                            position: destLoc,
                            map: map,
                            title: destName,
                            content: createMarkerHTML('#f5222d', 'ğŸ')
                        });
                    }
                    
                    // è·¯çº¿è§„åˆ’
                    const driving = new AMap.Driving({
                        map: map,
                        policy: AMap.DrivingPolicy.LEAST_TIME,
                        showTraffic: true,
                        hideMarkers: true
                    });
                    
                    driving.search(myLocation, destLoc, function(status, result) {
                        if (status === 'complete') {
                            const route = result.routes[0];
                            const time = Math.ceil(route.time / 60);
                            const distance = (route.distance / 1000).toFixed(1);
                            
                            currentRoute = result.routes;
                            map.setFitView();
                            
                            updateStatus(`âœ… å¯¼èˆªè§„åˆ’å®Œæˆï¼<br>ğŸ“ ${destName}<br>ğŸ“ ${distance}å…¬é‡Œ | â±ï¸ ${time}åˆ†é’Ÿ`, 'success');
                            
                            // è®°å½•å†å²
                            recordNavigation(destName, distance, time);
                        } else {
                            updateStatus('âŒ è·¯çº¿è§„åˆ’å¤±è´¥', 'error');
                        }
                    });
                    
                } else {
                    updateStatus('âŒ æ‰¾ä¸åˆ°ç›®çš„åœ°ï¼Œè¯·æ£€æŸ¥åœ°å€', 'error');
                }
            });
        }
        
        // è®°å½•å¯¼èˆªå†å²
        function recordNavigation(destName, distance, time) {
            const historyList = document.getElementById('history-list');
            const now = new Date().toLocaleTimeString();
            
            historyList.innerHTML = `
                <p>æœ€è¿‘å¯¼èˆªï¼š${destName}</p>
                <p>è·ç¦»ï¼š${distance} km</p>
                <p>æ—¶é—´ï¼š${time} åˆ†é’Ÿ</p>
                <p>æ—¶é—´ï¼š${now}</p>
            `;
        }
        
        // æ¸…é™¤å¯¼èˆª
        function clearNavigation() {
            if (destinationMarker) {
                map.remove(destinationMarker);
                destinationMarker = null;
            }
            if (currentRoute) {
                map.remove(currentRoute);
                currentRoute = null;
            }
            document.getElementById('dest-input').value = '';
            document.getElementById('nav-btn').disabled = true;
            updateStatus('ğŸ—‘ï¸ å·²æ¸…é™¤è·¯çº¿å’Œæ ‡è®°', 'info');
        }
        
        // å¼€å§‹æ¨¡æ‹Ÿ
        function startSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
            
            if (!map) return;
            
            isSimulationMode = true;
            updateStatus('ğŸ® å¼€å§‹æ¨¡æ‹Ÿç§»åŠ¨...', 'success');
            
            pathIndex = 0;
            simulationInterval = setInterval(() => {
                if (pathIndex >= simulationPath.length) {
                    pathIndex = 0;
                }
                
                const newLocation = simulationPath[pathIndex];
                
                // æ›´æ–°ä½ç½®
                if (currentMarker) {
                    currentMarker.setPosition(newLocation);
                } else {
                    currentMarker = new AMap.Marker({
                        position: newLocation,
                        map: map,
                        title: 'æ¨¡æ‹Ÿä½ç½®',
                        content: createMarkerHTML('#722ed1', 'ğŸ“')
                    });
                }
                
                // ç§»åŠ¨åœ°å›¾
                map.setCenter(newLocation);
                
                // æ›´æ–°æ˜¾ç¤º
                const speed = Math.floor(Math.random() * 30 + 20);
                document.getElementById('speed').textContent = speed + ' km/h';
                
                pathIndex++;
            }, 2000);
        }
        
        // åœæ­¢æ¨¡æ‹Ÿ
        function stopSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
                updateStatus('â¹ æ¨¡æ‹Ÿå·²åœæ­¢', 'info');
            }
        }
        
        // æ¨¡æ‹Ÿç¢°æ’
        function simulateCrash() {
            updateStatus('ğŸš¨ æ£€æµ‹åˆ°å‰§çƒˆç¢°æ’ï¼ç´§æ€¥åˆ¶åŠ¨å¯åŠ¨...', 'error');
            updateDeviceStatus('crash-detect', 'ç¢°æ’è­¦å‘Š', 'status-danger');
            
            // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºè­¦å‘Š
            if (currentMarker && map) {
                const crashMarker = new AMap.Marker({
                    position: currentMarker.getPosition(),
                    map: map,
                    content: '<div style="background:red;color:white;padding:10px;border-radius:5px;animation:blink 1s infinite;">ğŸ’¥ ç¢°æ’</div>'
                });
                
                // 10ç§’åç§»é™¤
                setTimeout(() => map.remove(crashMarker), 10000);
            }
            
            // 5ç§’åæ¢å¤æ­£å¸¸
            setTimeout(() => {
                updateDeviceStatus('crash-detect', 'æ­£å¸¸', 'status-good');
            }, 5000);
        }
        
        // æ¨¡æ‹Ÿæ±‚æ•‘
        function simulateSOS() {
            updateStatus('ğŸ†˜ SOSç´§æ€¥æ±‚åŠ©å·²å‘é€ï¼ä½ç½®ä¿¡æ¯å·²å…±äº«', 'error');
            
            if (currentMarker && map) {
                const sosMarker = new AMap.Marker({
                    position: currentMarker.getPosition(),
                    map: map,
                    content: '<div style="background:red;color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;animation:blink 0.5s infinite;">ğŸ†˜</div>'
                });
                
                setTimeout(() => map.remove(sosMarker), 10000);
            }
        }
        
        // æ›´æ–°çŠ¶æ€æç¤º
        function updateStatus(text, type) {
            const statusEl = document.getElementById('status-tip');
            statusEl.innerHTML = text;
            
            switch(type) {
                case 'success':
                    statusEl.style.background = '#f6ffed';
                    statusEl.style.border = '1px solid #b7eb8f';
                    statusEl.style.color = '#52c41a';
                    break;
                case 'error':
                    statusEl.style.background = '#fff2f0';
                    statusEl.style.border = '1px solid #ffccc7';
                    statusEl.style.color = '#ff4d4f';
                    break;
                case 'warning':
                    statusEl.style.background = '#fffbe6';
                    statusEl.style.border = '1px solid #ffe58f';
                    statusEl.style.color = '#faad14';
                    break;
                case 'info':
                    statusEl.style.background = '#e6f7ff';
                    statusEl.style.border = '1px solid #91d5ff';
                    statusEl.style.color = '#1890ff';
                    break;
            }
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€
        function updateDeviceStatus(elementId, text, statusClass) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                element.className = 'status-value ' + statusClass;
            }
        }
        
        // è®¾å¤‡æ•°æ®æ¨¡æ‹Ÿæ›´æ–°
        function startDeviceSimulation() {
            setInterval(() => {
                // æ¨¡æ‹Ÿç”µæ± ç”µé‡å˜åŒ–
                const battery = 80 + Math.floor(Math.random() * 20);
                updateDeviceStatus('battery', battery + '%', 
                    battery > 60 ? 'status-good' : 
                    battery > 30 ? 'status-warning' : 'status-danger');
            }, 5000);
        }
        
        // è°ƒè¯•ä¿¡æ¯
        console.log('æ™ºèƒ½å¤´ç›”ç›‘æ§å¯¼èˆªç³»ç»ŸåŠ è½½å®Œæˆ');
    </script>
    
    <style>
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</body>
</html>
