<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 添加以下meta标签确保地理位置权限请求正常 -->
    <meta name="referrer" content="no-referrer">
    <title>智能头盔监控导航系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        /* 登录模块 */
        .login-wrap {
            width: 380px;
            margin: 60px auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-wrap h2 {
            color: #0078d7;
            margin-bottom: 25px;
            font-size: 22px;
        }
        .login-wrap input {
            width: 100%;
            height: 45px;
            margin: 10px 0;
            padding: 0 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
        }
        .login-wrap input:focus {
            border-color: #0078d7;
        }
        .login-wrap button {
            width: 100%;
            height: 45px;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 5px;
        }
        .login-wrap button:hover {
            background: #005a9e;
        }
        /* 功能模块 */
        .func-wrap {
            display: none;
        }
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            height: 40px;
            padding: 0 20px;
            background: #f53f3f;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            z-index: 999;
        }
        .nav-module {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .nav-module h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .nav-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #dest-input {
            flex: 1;
            min-width: 280px;
            height: 45px;
            padding: 0 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
        }
        #dest-input:focus {
            border-color: #0078d7;
        }
        .nav-btn {
            height: 45px;
            padding: 0 25px;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .nav-btn:hover {
            background: #005a9e;
        }
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #map-container {
            width: 100%;
            height: 500px;
            border-radius: 6px;
            border: 1px solid #eee;
            background: #f9f9f9;
        }
        .map-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 16px;
        }
        #tip-text {
            margin-top: 12px;
            font-size: 14px;
            min-height: 20px;
        }
        .success { color: #00b42a; }
        .error { color: #f53f3f; }
        .default { color: #666; }
        .loading { color: #0078d7; }
    </style>
    <!-- 高德地图API - 注意：我用了自己的key，您需要替换成自己的 -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_AMAP_KEY_HERE&plugin=AMap.Geolocation,AMap.Geocoder,AMap.Driving,AMap.ToolBar"></script>
</head>
<body>
    <!-- 登录页面 -->
    <div class="login-wrap" id="loginPage">
        <h2>智能头盔系统登录</h2>
        <input type="text" id="user" placeholder="请输入用户名">
        <input type="password" id="pwd" placeholder="请输入密码">
        <button onclick="login()">登 录</button>
        <!-- 为了方便调试，添加测试登录按钮 -->
        <button onclick="quickLogin()" style="margin-top: 10px; background: #666;">测试登录</button>
    </div>

    <!-- 功能页面 -->
    <div class="container func-wrap" id="funcPage">
        <button class="logout-btn" onclick="logout()">退出登录</button>
        <div class="nav-module">
            <h2>头盔实时导航</h2>
            <div class="nav-controls">
                <input type="text" id="dest-input" placeholder="请输入目的地（例：天安门广场）">
                <button class="nav-btn" id="getLocBtn" onclick="getLocation()">获取当前定位</button>
                <button class="nav-btn" id="navBtn" onclick="goNav()" disabled>开始导航</button>
            </div>
            <div id="map-container">
                <div class="map-loading">地图加载中...</div>
            </div>
            <div id="tip-text" class="default">请先获取当前定位，再输入目的地导航</div>
        </div>
    </div>

    <script>
        // 全局变量
        let map = null;
        let myLoc = null;
        let geolocation = null;
        let isMapLoaded = false;

        // 页面加载
        window.onload = function() {
            checkLoginStatus();
        };

        // 测试登录（方便调试）
        function quickLogin() {
            localStorage.setItem('helmet_is_login', 'yes');
            checkLoginStatus();
        }

        // 检查登录状态
        function checkLoginStatus() {
            const isLogin = localStorage.getItem('helmet_is_login');
            if (isLogin === 'yes') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('funcPage').style.display = 'block';
                initMap();
            } else {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('funcPage').style.display = 'none';
            }
        }

        // 登录
        function login() {
            const user = document.getElementById('user').value.trim();
            const pwd = document.getElementById('pwd').value.trim();
            if (!user || !pwd) {
                alert('请输入用户名和密码！');
                return;
            }
            localStorage.setItem('helmet_is_login', 'yes');
            checkLoginStatus();
            alert('登录成功！');
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('helmet_is_login');
            window.location.reload();
        }

        // 初始化地图
        function initMap() {
            if (isMapLoaded) return;
            
            // 检查高德地图API是否加载完成
            if (!window.AMap) {
                setTip('地图API加载失败，请刷新页面重试', 'error');
                return;
            }
            
            setTip('地图初始化中...', 'loading');
            
            try {
                // 创建地图实例
                map = new AMap.Map('map-container', {
                    zoom: 13,
                    center: [116.397428, 39.90923], // 默认北京中心
                    resizeEnable: true,
                    animateEnable: true
                });
                
                // 添加工具栏
                map.addControl(new AMap.ToolBar({
                    position: 'RT'
                }));
                
                // 隐藏加载提示
                document.querySelector('#map-container .map-loading').style.display = 'none';
                isMapLoaded = true;
                setTip('地图初始化完成，可以开始定位', 'success');
                
            } catch (error) {
                console.error('地图初始化错误:', error);
                setTip('地图初始化失败: ' + error.message, 'error');
            }
        }

        // 获取定位
        function getLocation() {
            if (!map || !isMapLoaded) {
                setTip('地图未初始化，请稍候...', 'error');
                initMap();
                return;
            }
            
            const btn = document.getElementById('getLocBtn');
            btn.disabled = true;
            btn.textContent = '定位中...';
            
            setTip('正在获取位置信息...', 'loading');
            
            // 首先尝试高德定位
            if (!geolocation) {
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true, // 高精度定位
                    timeout: 10000, // 10秒超时
                    maximumAge: 0,
                    convert: true,
                    showButton: false,
                    showMarker: true,
                    panToLocation: true,
                    zoomToAccuracy: true
                });
                map.addControl(geolocation);
            }
            
            geolocation.getCurrentPosition((status, result) => {
                if (status === 'complete') {
                    onLocationSuccess(result);
                } else {
                    onLocationError(result);
                }
                btn.disabled = false;
                btn.textContent = '获取当前定位';
            });
        }

        // 定位成功
        function onLocationSuccess(result) {
            myLoc = result.position;
            
            // 清除之前的标记
            map.clearMap();
            
            // 添加当前位置标记
            new AMap.Marker({
                position: myLoc,
                map: map,
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                title: '我的位置'
            });
            
            // 移动到当前位置
            map.setCenter(myLoc);
            map.setZoom(16);
            
            // 启用导航按钮
            document.getElementById('navBtn').disabled = false;
            
            setTip(`定位成功！位置：${result.addressComponent.province}${result.addressComponent.city}${result.addressComponent.district}${result.addressComponent.township}`, 'success');
            
            // 显示定位精度
            if (result.accuracy) {
                console.log('定位精度:', result.accuracy + '米');
            }
        }

        // 定位失败
        function onLocationError(error) {
            console.error('定位失败:', error);
            
            // 尝试使用IP定位作为后备
            AMap.plugin('AMap.CitySearch', () => {
                const citySearch = new AMap.CitySearch();
                citySearch.getLocalCity((status, result) => {
                    if (status === 'complete' && result.city) {
                        // 使用城市中心作为默认位置
                        myLoc = result.center;
                        map.setCenter(myLoc);
                        map.setZoom(12);
                        
                        // 添加标记
                        new AMap.Marker({
                            position: myLoc,
                            map: map,
                            icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                            title: '大致位置（城市中心）'
                        });
                        
                        document.getElementById('navBtn').disabled = false;
                        setTip(`IP定位成功：${result.city}，精度较低，建议开启GPS`, 'default');
                    } else {
                        setTip(`定位失败：${error.message || '请检查定位权限'}`, 'error');
                    }
                });
            });
        }

        // 开始导航
        function goNav() {
            if (!myLoc) {
                setTip('请先获取当前位置', 'error');
                return;
            }
            
            const dest = document.getElementById('dest-input').value.trim();
            if (!dest) {
                setTip('请输入目的地', 'error');
                return;
            }
            
            const btn = document.getElementById('navBtn');
            btn.disabled = true;
            btn.textContent = '规划中...';
            
            setTip('正在规划路线...', 'loading');
            
            // 地理编码（将地址转换为坐标）
            const geocoder = new AMap.Geocoder();
            geocoder.getLocation(dest, (status, result) => {
                if (status === 'complete' && result.geocodes.length > 0) {
                    const destLoc = result.geocodes[0].location;
                    const destName = result.geocodes[0].formattedAddress;
                    
                    // 添加目的地标记
                    new AMap.Marker({
                        position: destLoc,
                        map: map,
                        icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png',
                        title: destName
                    });
                    
                    // 路线规划
                    const driving = new AMap.Driving({
                        map: map,
                        policy: AMap.DrivingPolicy.LEAST_TIME,
                        showTraffic: true,
                        hideMarkers: false,
                        isOutline: true,
                        outlineColor: '#ffeeee'
                    });
                    
                    driving.search(myLoc, destLoc, (status, result) => {
                        btn.disabled = false;
                        btn.textContent = '开始导航';
                        
                        if (status === 'complete') {
                            const route = result.routes[0];
                            const time = Math.ceil(route.time / 60);
                            const distance = (route.distance / 1000).toFixed(1);
                            
                            // 显示路线信息
                            map.setFitView();
                            
                            setTip(`导航规划完成！目的地：${destName}，距离：${distance}公里，预计时间：${time}分钟`, 'success');
                        } else {
                            setTip('路线规划失败，请检查目的地或网络', 'error');
                        }
                    });
                } else {
                    btn.disabled = false;
                    btn.textContent = '开始导航';
                    setTip('无法找到目的地，请检查地址是否正确', 'error');
                }
            });
        }

        // 设置提示信息
        function setTip(text, type) {
            const tip = document.getElementById('tip-text');
            tip.innerText = text;
            tip.className = type || 'default';
            
            // 如果是错误信息，3秒后恢复默认状态
            if (type === 'error') {
                setTimeout(() => {
                    if (tip.innerText === text) {
                        tip.className = 'default';
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>
