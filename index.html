<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            padding: 20px;
            background: #f0f2f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        
        .header h1 {
            color: #1890ff;
            font-size: 20px;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #ff4d4f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .nav-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        #dest-input {
            flex: 1;
            min-width: 200px;
            height: 40px;
            padding: 0 10px;
            border: 1px solid #d9d9d9;
            border-radius: 5px;
        }
        
        .control-btn {
            height: 40px;
            padding: 0 20px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .control-btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        #map-container {
            width: 100%;
            height: 500px;
            border: 1px solid #d9d9d9;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        #status {
            padding: 10px;
            background: #fafafa;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .success { color: #52c41a; }
        .error { color: #ff4d4f; }
        .info { color: #1890ff; }
    </style>
    <!-- é«˜å¾·åœ°å›¾API - å…³é”®ï¼šä½¿ç”¨JSAPI LoaderåŠ¨æ€åŠ è½½ -->
    <script src="https://webapi.amap.com/loader.js"></script>
</head>
<body>
    <div class="container" id="funcPage">
        <div class="header">
            <h1>ğŸï¸ æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿ</h1>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
        
        <div class="nav-panel">
            <div class="controls">
                <input type="text" id="dest-input" placeholder="è¾“å…¥ç›®çš„åœ°">
                <button class="control-btn" id="loc-btn" onclick="getSimpleLocation()">ğŸ“ è·å–ä½ç½®</button>
                <button class="control-btn" id="nav-btn" onclick="goSimpleNav()" disabled>ğŸš€ å¼€å§‹å¯¼èˆª</button>
                <button class="control-btn" onclick="clearSimpleMap()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div id="map-container"></div>
            <div id="status" class="info">ç‚¹å‡»"è·å–ä½ç½®"æŒ‰é’®å¼€å§‹ä½¿ç”¨</div>
        </div>
    </div>

    <script>
        // æç®€ç‰ˆæœ¬ - åªä¿ç•™æ ¸å¿ƒåŠŸèƒ½
        let map = null;
        let myLocation = null;
        let marker = null;
        
        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        window.onload = function() {
            initSimpleMap();
        };
        
        // åˆå§‹åŒ–åœ°å›¾ - ä½¿ç”¨JSAPI Loader
        function initSimpleMap() {
            // ä½¿ç”¨é«˜å¾·JSAPI LoaderåŠ¨æ€åŠ è½½
            AMapLoader.load({
                "key": "977b6123358698744cd4f2a96e219145",  // æ‚¨çš„Key
                "version": "2.0",
                "plugins": ['AMap.Geolocation', 'AMap.Geocoder', 'AMap.Driving', 'AMap.ToolBar']
            }).then((AMap) => {
                console.log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
                
                // åˆ›å»ºåœ°å›¾
                map = new AMap.Map('map-container', {
                    zoom: 12,
                    center: [116.397428, 39.90923], // åŒ—äº¬
                    resizeEnable: true
                });
                
                // æ·»åŠ å·¥å…·æ 
                map.addControl(new AMap.ToolBar());
                
                updateStatus('åœ°å›¾åŠ è½½å®Œæˆï¼ç‚¹å‡»"è·å–ä½ç½®"æŒ‰é’®', 'success');
                
            }).catch((e) => {
                console.error('é«˜å¾·åœ°å›¾åŠ è½½å¤±è´¥:', e);
                updateStatus('åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            });
        }
        
        // è·å–ä½ç½® - ç®€åŒ–ç‰ˆæœ¬
        function getSimpleLocation() {
            if (!map) {
                updateStatus('åœ°å›¾æœªå°±ç»ªï¼Œè¯·ç¨å€™...', 'error');
                return;
            }
            
            const btn = document.getElementById('loc-btn');
            btn.disabled = true;
            btn.textContent = 'å®šä½ä¸­...';
            
            updateStatus('æ­£åœ¨è·å–ä½ç½®...', 'info');
            
            // ä½¿ç”¨é«˜å¾·å®šä½æ’ä»¶
            const geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,    // æ˜¯å¦ä½¿ç”¨é«˜ç²¾åº¦å®šä½
                timeout: 10000,              // è¶…æ—¶æ—¶é—´
                maximumAge: 0,               // å®šä½ç»“æœç¼“å­˜0æ¯«ç§’
                convert: true,               // è‡ªåŠ¨åç§»åæ ‡
                showButton: false,           // ä¸æ˜¾ç¤ºå®šä½æŒ‰é’®
                panToLocation: true,         // å®šä½æˆåŠŸåå°†ä½ç½®ç§»åŠ¨åˆ°åœ°å›¾ä¸­å¿ƒ
                zoomToAccuracy: true         // å®šä½æˆåŠŸåè°ƒæ•´åœ°å›¾è§†é‡èŒƒå›´ä½¿å®šä½ä½ç½®åŠç²¾åº¦èŒƒå›´è§†é‡å†…å¯è§
            });
            
            // æ·»åŠ å®šä½æ§ä»¶åˆ°åœ°å›¾
            map.addControl(geolocation);
            
            // è·å–å½“å‰ä½ç½®
            geolocation.getCurrentPosition(function(status, result) {
                console.log('å®šä½ç»“æœ:', status, result);
                
                btn.disabled = false;
                btn.textContent = 'ğŸ“ è·å–ä½ç½®';
                
                if (status === 'complete') {
                    onSimpleLocationSuccess(result);
                } else {
                    onSimpleLocationError(result);
                }
            });
        }
        
        // å®šä½æˆåŠŸ
        function onSimpleLocationSuccess(result) {
            myLocation = result.position;
            
            // æ¸…é™¤æ—§æ ‡è®°
            if (marker) {
                map.remove(marker);
            }
            
            // åˆ›å»ºæ ‡è®°
            marker = new AMap.Marker({
                position: myLocation,
                map: map,
                title: 'æˆ‘çš„ä½ç½®',
                content: '<div style="background:#1890ff;width:20px;height:20px;border-radius:50%;border:3px solid white;"></div>'
            });
            
            // ç§»åŠ¨åˆ°ä½ç½®
            map.setCenter(myLocation);
            map.setZoom(16);
            
            // å¯ç”¨å¯¼èˆªæŒ‰é’®
            document.getElementById('nav-btn').disabled = false;
            
            // æ˜¾ç¤ºåœ°å€ä¿¡æ¯
            const address = result.addressComponent;
            const addr = address ? `${address.province || ''}${address.city || ''}${address.district || ''}` : 'å½“å‰ä½ç½®';
            
            updateStatus(`ğŸ“ å®šä½æˆåŠŸï¼ä½ç½®ï¼š${addr}`, 'success');
        }
        
        // å®šä½å¤±è´¥
        function onSimpleLocationError(error) {
            console.error('å®šä½å¤±è´¥:', error);
            
            // å°è¯•ä½¿ç”¨IPå®šä½
            updateStatus('ç²¾ç¡®å®šä½å¤±è´¥ï¼Œå°è¯•IPå®šä½...', 'info');
            
            // ä½¿ç”¨åŸå¸‚æœç´¢è·å–å¤§è‡´ä½ç½®
            AMap.plugin('AMap.CitySearch', function() {
                const citySearch = new AMap.CitySearch();
                
                citySearch.getLocalCity(function(status, result) {
                    if (status === 'complete' && result.city) {
                        // ä½¿ç”¨åŸå¸‚ä¸­å¿ƒ
                        myLocation = result.center;
                        
                        // åˆ›å»ºæ ‡è®°
                        marker = new AMap.Marker({
                            position: myLocation,
                            map: map,
                            title: 'å¤§è‡´ä½ç½®',
                            content: '<div style="background:#faad14;width:20px;height:20px;border-radius:50%;border:3px solid white;"></div>'
                        });
                        
                        map.setCenter(myLocation);
                        map.setZoom(12);
                        
                        document.getElementById('nav-btn').disabled = false;
                        updateStatus(`ğŸ“ IPå®šä½ï¼š${result.city}ï¼ˆç²¾åº¦è¾ƒä½ï¼‰`, 'success');
                    } else {
                        updateStatus('å®šä½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™', 'error');
                    }
                });
            });
        }
        
        // å¼€å§‹å¯¼èˆª
        function goSimpleNav() {
            if (!myLocation) {
                updateStatus('è¯·å…ˆè·å–ä½ç½®', 'error');
                return;
            }
            
            const dest = document.getElementById('dest-input').value.trim();
            if (!dest) {
                updateStatus('è¯·è¾“å…¥ç›®çš„åœ°', 'error');
                return;
            }
            
            const btn = document.getElementById('nav-btn');
            btn.disabled = true;
            btn.textContent = 'è§„åˆ’ä¸­...';
            
            updateStatus('æ­£åœ¨è§„åˆ’è·¯çº¿...', 'info');
            
            // åœ°ç†ç¼–ç 
            const geocoder = new AMap.Geocoder();
            geocoder.getLocation(dest, function(status, result) {
                if (status === 'complete' && result.geocodes.length > 0) {
                    const destLoc = result.geocodes[0].location;
                    const destName = result.geocodes[0].formattedAddress;
                    
                    // æ·»åŠ ç›®çš„åœ°æ ‡è®°
                    const destMarker = new AMap.Marker({
                        position: destLoc,
                        map: map,
                        title: destName,
                        content: '<div style="background:#f5222d;width:20px;height:20px;border-radius:50%;border:3px solid white;"></div>'
                    });
                    
                    // è·¯çº¿è§„åˆ’
                    const driving = new AMap.Driving({
                        map: map,
                        policy: AMap.DrivingPolicy.LEAST_TIME,
                        showTraffic: true
                    });
                    
                    driving.search(myLocation, destLoc, function(status, result) {
                        btn.disabled = false;
                        btn.textContent = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                        
                        if (status === 'complete') {
                            const route = result.routes[0];
                            const time = Math.ceil(route.time / 60);
                            const distance = (route.distance / 1000).toFixed(1);
                            
                            map.setFitView();
                            updateStatus(`âœ… å¯¼èˆªå®Œæˆï¼${destName} | ${distance}å…¬é‡Œ | ${time}åˆ†é’Ÿ`, 'success');
                        } else {
                            updateStatus('è·¯çº¿è§„åˆ’å¤±è´¥', 'error');
                        }
                    });
                } else {
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                    updateStatus('æ‰¾ä¸åˆ°ç›®çš„åœ°', 'error');
                }
            });
        }
        
        // æ¸…é™¤åœ°å›¾
        function clearSimpleMap() {
            if (map) {
                map.clearMap();
                marker = null;
                document.getElementById('nav-btn').disabled = true;
                updateStatus('å·²æ¸…é™¤', 'info');
            }
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, type) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = type || 'info';
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('helmet_login');
            window.location.reload();
        }
    </script>
</body>
</html>
