<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能头盔定位导航</title>
    <style>
        body, html { margin:0; padding:0; width:100%; height:100%; }
        #container { width:100%; height:100%; }
        #panel { position:absolute; top:10px; left:10px; background:white; padding:10px; border-radius:5px; z-index:999; }
        input, button { margin:5px; padding:8px; }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="panel">
        <input type="text" id="dest" placeholder="输入目的地" style="width:200px;">
        <br>
        <button onclick="getLocation()">获取我的位置</button>
        <button onclick="startNav()" id="navBtn" disabled>开始导航</button>
        <div id="info" style="margin-top:10px;"></div>
    </div>

    <!-- 高德地图API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=977b6123358698744cd4f2a96e219145"></script>
    
    <script>
        // 初始化地图
        var map = new AMap.Map('container', {
            zoom: 12,
            center: [116.397428, 39.90923] // 北京
        });
        
        // 添加工具栏
        map.addControl(new AMap.ToolBar());
        
        var myMarker = null;
        var myPosition = null;
        
        // 获取位置
        function getLocation() {
            document.getElementById('info').innerHTML = '正在定位...';
            
            // 加载定位插件
            AMap.plugin('AMap.Geolocation', function() {
                var geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    buttonPosition:'RB'
                });
                
                map.addControl(geolocation);
                
                geolocation.getCurrentPosition(function(status, result) {
                    if (status === 'complete') {
                        onLocationSuccess(result);
                    } else {
                        onLocationError(result);
                    }
                });
            });
        }
        
        // 定位成功
        function onLocationSuccess(result) {
            myPosition = result.position;
            
            // 移除旧标记
            if (myMarker) {
                map.remove(myMarker);
            }
            
            // 添加我的位置标记
            myMarker = new AMap.Marker({
                position: myPosition,
                map: map,
                title: '我的位置',
                content: '<div style="background:#1890ff;width:20px;height:20px;border-radius:50%;border:2px solid white;"></div>'
            });
            
            // 移动到我的位置
            map.setCenter(myPosition);
            map.setZoom(16);
            
            // 启用导航按钮
            document.getElementById('navBtn').disabled = false;
            
            document.getElementById('info').innerHTML = '定位成功！';
        }
        
        // 定位失败
        function onLocationError(err) {
            document.getElementById('info').innerHTML = '定位失败，使用默认位置';
            
            // 使用默认位置
            myPosition = [116.397428, 39.90923];
            
            if (myMarker) {
                map.remove(myMarker);
            }
            
            myMarker = new AMap.Marker({
                position: myPosition,
                map: map,
                title: '默认位置'
            });
            
            map.setCenter(myPosition);
            document.getElementById('navBtn').disabled = false;
        }
        
        // 开始导航
        function startNav() {
            var dest = document.getElementById('dest').value.trim();
            if (!dest) {
                document.getElementById('info').innerHTML = '请输入目的地';
                return;
            }
            
            document.getElementById('info').innerHTML = '正在规划路线...';
            
            // 加载地理编码插件
            AMap.plugin('AMap.Geocoder', function() {
                var geocoder = new AMap.Geocoder();
                
                geocoder.getLocation(dest, function(status, result) {
                    if (status === 'complete' && result.geocodes.length > 0) {
                        var destLocation = result.geocodes[0].location;
                        var destName = result.geocodes[0].formattedAddress;
                        
                        // 添加目的地标记
                        var destMarker = new AMap.Marker({
                            position: destLocation,
                            map: map,
                            title: destName,
                            content: '<div style="background:red;width:20px;height:20px;border-radius:50%;border:2px solid white;"></div>'
                        });
                        
                        // 加载导航插件
                        AMap.plugin('AMap.Driving', function() {
                            var driving = new AMap.Driving({
                                map: map,
                                panel: 'panel',
                                policy: AMap.DrivingPolicy.LEAST_TIME,
                                showTraffic: true
                            });
                            
                            driving.search(myPosition, destLocation, function(status, result) {
                                if (status === 'complete') {
                                    document.getElementById('info').innerHTML = '导航规划完成！';
                                } else {
                                    document.getElementById('info').innerHTML = '路线规划失败';
                                }
                            });
                        });
                        
                    } else {
                        document.getElementById('info').innerHTML = '找不到目的地';
                    }
                });
            });
        }
        
        // 页面加载后自动获取位置（可选）
        // setTimeout(getLocation, 1000);
        
        console.log('地图初始化完成，Key验证通过');
    </script>
</body>
</html>
