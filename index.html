<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤´ç›”ç›‘æ§å¯¼èˆªç³»ç»Ÿ</title>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ï¼Œåªæ·»åŠ å®šä½æˆæƒæç¤ºæ ·å¼ */
        .location-permission {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .permission-btn {
            padding: 8px 20px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .permission-btn:hover {
            background: #40a9ff;
        }
        
        /* åŸæœ‰æ‰€æœ‰æ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        /* ... å…¶ä»–åŸæœ‰æ ·å¼ä¿æŒä¸å˜ ... */
        .login-wrap {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            text-align: center;
            animation: slideIn 0.5s ease;
        }
        
        .login-wrap h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }
        
        .login-input {
            width: 100%;
            height: 50px;
            margin: 15px 0;
            padding: 0 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        .login-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-btn {
            width: 100%;
            height: 50px;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.3);
        }
        
        .func-wrap {
            width: 100%;
            max-width: 1200px;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }
        
        .logout-btn {
            padding: 10px 25px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: #ff3742;
            transform: translateY(-2px);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 2px solid #f1f3f9;
            padding-bottom: 10px;
        }
        
        .nav-module {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .nav-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        #dest-input {
            flex: 1;
            min-width: 250px;
            height: 50px;
            padding: 0 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        #dest-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .nav-btn {
            height: 50px;
            padding: 0 30px;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.3);
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #map-container {
            width: 100%;
            height: 500px;
            border-radius: 15px;
            border: 2px solid #e1e5e9;
            background: #f8f9fa;
            overflow: hidden;
            position: relative;
        }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 16px;
        }
        
        #tip-text {
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
            padding: 10px 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .success {
            color: #00b894;
            background: rgba(0, 184, 148, 0.1);
        }
        
        .error {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }
        
        .default {
            color: #666;
        }
        
        .loading {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .nav-controls {
                flex-direction: column;
            }
            
            #dest-input {
                min-width: 100%;
            }
            
            .nav-btn {
                width: 100%;
            }
        }
    </style>
    <!-- é«˜å¾·åœ°å›¾API - ä½¿ç”¨æ‚¨çš„Key -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=977b6123358698744cd4f2a96e219145&plugin=AMap.Geolocation,AMap.Geocoder,AMap.Driving,AMap.ToolBar"></script>
    <link rel="stylesheet" href="https://webapi.amap.com/ui/1.1/main.css">
    <script src="https://webapi.amap.com/ui/1.1/main.js"></script>
</head>
<body>
    <!-- å®šä½æƒé™æç¤º -->
    <div class="location-permission" id="permissionTip">
        <span>ğŸ” æ™ºèƒ½å¤´ç›”éœ€è¦è·å–æ‚¨çš„ä½ç½®æƒé™</span>
        <button class="permission-btn" onclick="requestPermission()">å…è®¸å®šä½</button>
    </div>

    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-wrap" id="loginPage">
        <h2>ğŸ” æ™ºèƒ½å¤´ç›”ç³»ç»Ÿ</h2>
        <input type="text" id="user" class="login-input" placeholder="ç”¨æˆ·å" value="admin">
        <input type="password" id="pwd" class="login-input" placeholder="å¯†ç " value="123456">
        <button class="login-btn" onclick="login()">ç™»å½•ç³»ç»Ÿ</button>
        <p style="margin-top: 20px; color: #666; font-size: 14px;">
            æµ‹è¯•è´¦å·ï¼šadmin / 123456
        </p>
    </div>

    <!-- ä¸»åŠŸèƒ½é¡µé¢ -->
    <div class="func-wrap" id="funcPage">
        <div class="header">
            <h1>ğŸï¸ æ™ºèƒ½å¤´ç›”ç›‘æ§å¯¼èˆªç³»ç»Ÿ</h1>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h2>ğŸ“Š å®æ—¶æ•°æ®</h2>
                <div id="data-display">
                    <p>ğŸ“¡ GPSä¿¡å·ï¼š<span id="gps-status" class="default">ç­‰å¾…è¿æ¥...</span></p>
                    <p>ğŸ”‹ ç”µé‡ï¼š<span id="battery-status" class="default">--%</span></p>
                    <p>ğŸŒ¡ï¸ æ¸©åº¦ï¼š<span id="temp-status" class="default">--Â°C</span></p>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸš¨ å®‰å…¨çŠ¶æ€</h2>
                <div id="safety-status">
                    <p>ğŸª– å¤´ç›”ä½©æˆ´ï¼š<span id="helmet-status" class="success">æ­£å¸¸</span></p>
                    <p>âš ï¸ ç¢°æ’æ£€æµ‹ï¼š<span id="crash-status" class="success">æœªæ£€æµ‹åˆ°</span></p>
                    <p>ğŸ†˜ SOSç´§æ€¥ï¼š<span id="sos-status" class="success">æœªè§¦å‘</span></p>
                </div>
            </div>
        </div>
        
        <div class="nav-module">
            <h2>ğŸ§­ å®æ—¶å¯¼èˆª</h2>
            <div class="nav-controls">
                <input type="text" id="dest-input" placeholder="è¯·è¾“å…¥ç›®çš„åœ°ï¼Œå¦‚ï¼šå¤©å®‰é—¨å¹¿åœºã€åŒ—äº¬è¥¿ç«™">
                <button class="nav-btn" id="getLocBtn" onclick="getLocation()">
                    ğŸ“ è·å–å½“å‰ä½ç½®
                </button>
                <button class="nav-btn" id="navBtn" onclick="goNav()" disabled>
                    ğŸš€ å¼€å§‹å¯¼èˆª
                </button>
                <button class="nav-btn" id="clearBtn" onclick="clearMap()">
                    ğŸ—‘ï¸ æ¸…é™¤è·¯çº¿
                </button>
            </div>
            <div id="map-container">
                <div class="map-loading" id="mapLoading">
                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ—ºï¸</div>
                    <div>åœ°å›¾åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div id="tip-text" class="default">
                ğŸ‘‹ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿï¼è¯·å…ˆç‚¹å‡»"è·å–å½“å‰ä½ç½®"æŒ‰é’®
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let myLoc = null;
        let isLoggedIn = false;
        let markers = [];
        let currentRoute = null;
        let geolocation = null;
        let hasLocationPermission = false;

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€...');
            checkLogin();
            
            // æ£€æŸ¥å®šä½æƒé™çŠ¶æ€
            checkPermission();
            
            // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®æ›´æ–°
            setInterval(updateDeviceData, 3000);
        });

        // æ£€æŸ¥å®šä½æƒé™
        function checkPermission() {
            if ('permissions' in navigator) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(permissionStatus => {
                        console.log('å®šä½æƒé™çŠ¶æ€:', permissionStatus.state);
                        hasLocationPermission = permissionStatus.state === 'granted';
                        
                        // ç›‘å¬æƒé™å˜åŒ–
                        permissionStatus.onchange = function() {
                            console.log('æƒé™çŠ¶æ€å˜åŒ–:', this.state);
                            hasLocationPermission = this.state === 'granted';
                        };
                    })
                    .catch(err => {
                        console.log('æƒé™æŸ¥è¯¢å¤±è´¥:', err);
                        hasLocationPermission = false;
                    });
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒæƒé™æŸ¥è¯¢API');
                // é»˜è®¤è®¤ä¸ºæ²¡æœ‰æƒé™ï¼Œéœ€è¦ç”¨æˆ·ç‚¹å‡»
                hasLocationPermission = false;
            }
        }

        // è¯·æ±‚å®šä½æƒé™
        function requestPermission() {
            const permissionTip = document.getElementById('permissionTip');
            permissionTip.style.display = 'none';
            
            showTip('ğŸ” æ­£åœ¨è¯·æ±‚å®šä½æƒé™...', 'loading');
            
            // ç›´æ¥è°ƒç”¨å®šä½ï¼Œæµè§ˆå™¨ä¼šå¼¹å‡ºæƒé™è¯·æ±‚
            getLocation();
        }

        // æ˜¾ç¤ºæƒé™æç¤º
        function showPermissionTip() {
            if (!hasLocationPermission) {
                const permissionTip = document.getElementById('permissionTip');
                permissionTip.style.display = 'flex';
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    permissionTip.style.display = 'none';
                }, 5000);
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            const savedLogin = localStorage.getItem('helmet_login');
            console.log('ç™»å½•çŠ¶æ€:', savedLogin);
            if (savedLogin === 'true') {
                showMainPage();
            } else {
                showLoginPage();
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µ
        function showLoginPage() {
            console.log('æ˜¾ç¤ºç™»å½•é¡µ');
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('funcPage').style.display = 'none';
            isLoggedIn = false;
        }

        // æ˜¾ç¤ºä¸»é¡µé¢
        function showMainPage() {
            console.log('æ˜¾ç¤ºä¸»é¡µé¢');
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('funcPage').style.display = 'block';
            isLoggedIn = true;
            
            // å»¶è¿Ÿåˆå§‹åŒ–åœ°å›¾ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(initMap, 500);
            
            // æ˜¾ç¤ºå®šä½æƒé™æç¤º
            setTimeout(showPermissionTip, 1000);
        }

        // ç™»å½•
        function login() {
            const user = document.getElementById('user').value.trim();
            const pwd = document.getElementById('pwd').value.trim();
            
            console.log('ç™»å½•å°è¯•:', user, pwd);
            
            // ç®€å•éªŒè¯ï¼ˆæ¯”èµ›é¡¹ç›®å¯ç®€åŒ–ï¼‰
            if (user === 'admin' && pwd === '123456') {
                localStorage.setItem('helmet_login', 'true');
                showMainPage();
                showTip('âœ… ç™»å½•æˆåŠŸï¼æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å¤´ç›”ç³»ç»Ÿ', 'success');
            } else {
                showTip('âŒ ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼ä½¿ç”¨ admin / 123456', 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('helmet_login');
            showLoginPage();
            showTip('ğŸ‘‹ å·²é€€å‡ºç™»å½•', 'default');
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            console.log('å¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
            
            if (map) {
                console.log('åœ°å›¾å·²å­˜åœ¨ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–');
                return;
            }
            
            // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦åŠ è½½
            if (!window.AMap) {
                console.error('é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
                document.getElementById('mapLoading').innerHTML = 
                    '<div style="color: #ff4757;">âš ï¸ åœ°å›¾APIåŠ è½½å¤±è´¥</div>';
                return;
            }
            
            try {
                console.log('åˆ›å»ºåœ°å›¾å®ä¾‹...');
                
                // åˆ›å»ºåœ°å›¾å®ä¾‹
                map = new AMap.Map('map-container', {
                    zoom: 13,
                    center: [116.397428, 39.90923], // åŒ—äº¬å¤©å®‰é—¨
                    resizeEnable: true,
                    animateEnable: true,
                    viewMode: '2D'
                });
                
                console.log('åœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸ');
                
                // æ·»åŠ å·¥å…·æ 
                map.addControl(new AMap.ToolBar({
                    position: 'RB'
                }));
                
                // éšè—åŠ è½½æç¤º
                document.getElementById('mapLoading').style.display = 'none';
                
                // æ£€æŸ¥åœ°å›¾æ˜¯å¦æ¸²æŸ“æˆåŠŸ
                setTimeout(function() {
                    if (map && map.getSize().width > 0) {
                        showTip('ğŸ—ºï¸ åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼å¯ä»¥å¼€å§‹ä½¿ç”¨å¯¼èˆªåŠŸèƒ½', 'success');
                        console.log('åœ°å›¾æ¸²æŸ“æˆåŠŸ');
                    } else {
                        showTip('âš ï¸ åœ°å›¾æ¸²æŸ“å¼‚å¸¸ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢', 'error');
                        console.error('åœ°å›¾æ¸²æŸ“å¼‚å¸¸');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–é”™è¯¯:', error);
                document.getElementById('mapLoading').innerHTML = 
                    `<div style="color: #ff4757;">âš ï¸ åœ°å›¾åˆå§‹åŒ–å¤±è´¥</div>`;
            }
        }

        // è·å–å½“å‰ä½ç½® - ä¿®å¤ç‰ˆ
        function getLocation() {
            console.log('å¼€å§‹è·å–ä½ç½®...');
            
            if (!map) {
                showTip('âš ï¸ åœ°å›¾æœªåˆå§‹åŒ–ï¼Œè¯·ç¨å€™...', 'error');
                initMap();
                setTimeout(getLocation, 1000);
                return;
            }
            
            const btn = document.getElementById('getLocBtn');
            btn.disabled = true;
            btn.innerHTML = 'ğŸ“ å®šä½ä¸­...';
            
            // éšè—æƒé™æç¤º
            document.getElementById('permissionTip').style.display = 'none';
            
            showTip('ğŸ” æ­£åœ¨è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯...', 'loading');
            
            // æ¸…é™¤æ—§æ ‡è®°
            clearMarkers();
            
            // æ–¹æ³•1ï¼šå…ˆå°è¯•æµè§ˆå™¨åŸç”Ÿå®šä½ï¼ˆç²¾åº¦æ›´é«˜ï¼‰
            if (navigator.geolocation) {
                console.log('ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå®šä½...');
                
                navigator.geolocation.getCurrentPosition(
                    // æˆåŠŸå›è°ƒ
                    function(position) {
                        console.log('æµè§ˆå™¨å®šä½æˆåŠŸ:', position);
                        
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        myLoc = [lng, lat]; // æ³¨æ„ï¼šé«˜å¾·åæ ‡é¡ºåºæ˜¯[lng, lat]
                        
                        // æ ‡è®°ä½ç½®
                        addMyLocationMarker(myLoc, 'æµè§ˆå™¨å®šä½');
                        
                        // å¯ç”¨å¯¼èˆªæŒ‰é’®
                        document.getElementById('navBtn').disabled = false;
                        
                        showTip('âœ… æµè§ˆå™¨å®šä½æˆåŠŸï¼ä½ç½®å·²è·å–', 'success');
                        updateGPSStatus('å·²è¿æ¥', 'success');
                        
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ“ è·å–å½“å‰ä½ç½®';
                    },
                    // å¤±è´¥å›è°ƒ
                    function(error) {
                        console.log('æµè§ˆå™¨å®šä½å¤±è´¥:', error);
                        
                        // æ–¹æ³•2ï¼šå¦‚æœæµè§ˆå™¨å®šä½å¤±è´¥ï¼Œä½¿ç”¨é«˜å¾·å®šä½
                        useAmapGeolocation(btn);
                    },
                    // é…ç½®
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒåŸç”Ÿå®šä½ï¼Œä½¿ç”¨é«˜å¾·å®šä½');
                useAmapGeolocation(btn);
            }
        }

        // ä½¿ç”¨é«˜å¾·å®šä½
        function useAmapGeolocation(btn) {
            console.log('ä½¿ç”¨é«˜å¾·åœ°å›¾å®šä½...');
            
            // ä½¿ç”¨é«˜å¾·åœ°å›¾å®šä½
            if (!geolocation) {
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0,
                    convert: true,
                    showButton: false,
                    panToLocation: true,
                    zoomToAccuracy: true
                });
                map.addControl(geolocation);
            }
            
            geolocation.getCurrentPosition(function(status, result) {
                console.log('é«˜å¾·å®šä½ç»“æœ:', status, result);
                
                if (status === 'complete') {
                    onLocationSuccess(result);
                } else {
                    onLocationError(result);
                }
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“ è·å–å½“å‰ä½ç½®';
            });
        }

        // å®šä½æˆåŠŸ
        function onLocationSuccess(result) {
            console.log('é«˜å¾·å®šä½æˆåŠŸ:', result);
            myLoc = result.position;
            
            // æ ‡è®°ä½ç½®
            addMyLocationMarker(myLoc, 'é«˜å¾·å®šä½');
            
            // ç§»åŠ¨åˆ°å½“å‰ä½ç½®
            map.setCenter(myLoc);
            map.setZoom(16);
            
            // å¯ç”¨å¯¼èˆªæŒ‰é’®
            document.getElementById('navBtn').disabled = false;
            
            // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
            const address = result.addressComponent || {};
            let locationText = '';
            if (address.province) locationText += address.province;
            if (address.city) locationText += address.city;
            if (address.district) locationText += address.district;
            if (address.township) locationText += address.township;
            
            if (!locationText) locationText = 'å½“å‰ä½ç½®';
            
            showTip(`âœ… å®šä½æˆåŠŸï¼ä½ç½®ï¼š${locationText}`, 'success');
            
            // æ›´æ–°GPSçŠ¶æ€æ˜¾ç¤º
            updateGPSStatus('å·²è¿æ¥', 'success');
        }

        // æ·»åŠ æˆ‘çš„ä½ç½®æ ‡è®°
        function addMyLocationMarker(position, title) {
            const marker = new AMap.Marker({
                position: position,
                map: map,
                title: title,
                content: '<div style="background:#1890ff;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>'
            });
            
            markers.push(marker);
        }

        // å®šä½å¤±è´¥
        function onLocationError(error) {
            console.error('é«˜å¾·å®šä½å¤±è´¥:', error);
            
            // å°è¯•ä½¿ç”¨IPå®šä½
            showTip('âš ï¸ å°è¯•IPå®šä½è·å–å¤§è‡´ä½ç½®...', 'loading');
            
            const citySearch = new AMap.CitySearch();
            
            citySearch.getLocalCity(function(status, result) {
                if (status === 'complete' && result.city) {
                    console.log('IPå®šä½æˆåŠŸ:', result);
                    myLoc = result.center;
                    
                    // æ ‡è®°å¤§è‡´ä½ç½®
                    const marker = new AMap.Marker({
                        position: myLoc,
                        map: map,
                        title: 'å¤§è‡´ä½ç½®',
                        content: '<div style="background:#faad14;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>'
                    });
                    
                    markers.push(marker);
                    
                    map.setCenter(myLoc);
                    map.setZoom(12);
                    
                    document.getElementById('navBtn').disabled = false;
                    showTip(`âš ï¸ IPå®šä½ï¼š${result.city}ï¼ˆç²¾åº¦è¾ƒä½ï¼‰`, 'default');
                    
                    // æ›´æ–°GPSçŠ¶æ€
                    updateGPSStatus('å¼±ä¿¡å·', 'error');
                    
                } else {
                    // å¦‚æœIPå®šä½ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                    console.log('IPå®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                    myLoc = [116.397428, 39.90923]; // åŒ—äº¬å¤©å®‰é—¨
                    map.setCenter(myLoc);
                    map.setZoom(10);
                    
                    showTip('âŒ å®šä½å¤±è´¥ï¼ä½¿ç”¨é»˜è®¤ä½ç½®ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™', 'error');
                    
                    // æ›´æ–°GPSçŠ¶æ€
                    updateGPSStatus('æœªè¿æ¥', 'error');
                }
            });
        }

        // æ›´æ–°GPSçŠ¶æ€
        function updateGPSStatus(text, type) {
            const gpsStatus = document.getElementById('gps-status');
            gpsStatus.textContent = text;
            gpsStatus.className = type;
        }

        // å¼€å§‹å¯¼èˆª
        function goNav() {
            if (!myLoc) {
                showTip('âš ï¸ è¯·å…ˆè·å–å½“å‰ä½ç½®ï¼', 'error');
                return;
            }
            
            const dest = document.getElementById('dest-input').value.trim();
            if (!dest) {
                showTip('âš ï¸ è¯·è¾“å…¥ç›®çš„åœ°ï¼', 'error');
                return;
            }
            
            console.log('å¼€å§‹å¯¼èˆªåˆ°:', dest);
            
            const btn = document.getElementById('navBtn');
            btn.disabled = true;
            btn.innerHTML = 'ğŸš€ è§„åˆ’ä¸­...';
            
            showTip('ğŸ—ºï¸ æ­£åœ¨è§„åˆ’è·¯çº¿...', 'loading');
            
            // æ¸…é™¤æ—§è·¯çº¿
            if (currentRoute) {
                map.remove(currentRoute);
                currentRoute = null;
            }
            
            // åœ°ç†ç¼–ç 
            const geocoder = new AMap.Geocoder();
            geocoder.getLocation(dest, function(status, result) {
                if (status === 'complete' && result.geocodes.length > 0) {
                    const destLoc = result.geocodes[0].location;
                    const destName = result.geocodes[0].formattedAddress;
                    
                    console.log('ç›®çš„åœ°è§£ææˆåŠŸ:', destName, destLoc);
                    
                    // æ·»åŠ ç›®çš„åœ°æ ‡è®°
                    const destMarker = new AMap.Marker({
                        position: destLoc,
                        map: map,
                        title: destName,
                        content: '<div style="background:#f5222d;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>'
                    });
                    
                    markers.push(destMarker);
                    
                    // è·¯çº¿è§„åˆ’
                    const driving = new AMap.Driving({
                        map: map,
                        policy: AMap.DrivingPolicy.LEAST_TIME,
                        showTraffic: true,
                        hideMarkers: true
                    });
                    
                    driving.search(myLoc, destLoc, function(status, result) {
                        console.log('è·¯çº¿è§„åˆ’ç»“æœ:', status);
                        
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                        
                        if (status === 'complete') {
                            const route = result.routes[0];
                            const time = Math.ceil(route.time / 60);
                            const distance = (route.distance / 1000).toFixed(1);
                            
                            currentRoute = result.routes;
                            map.setFitView();
                            
                            showTip(`âœ… å¯¼èˆªè§„åˆ’å®Œæˆï¼ç›®çš„åœ°ï¼š${destName}<br>ğŸ“ è·ç¦»ï¼š${distance}å…¬é‡Œ â±ï¸ æ—¶é—´ï¼š${time}åˆ†é’Ÿ`, 'success');
                        } else {
                            showTip('âŒ è·¯çº¿è§„åˆ’å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›®çš„åœ°æˆ–ç½‘ç»œ', 'error');
                        }
                    });
                } else {
                    console.log('ç›®çš„åœ°è§£æå¤±è´¥');
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                    showTip('âŒ æ‰¾ä¸åˆ°ç›®çš„åœ°ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®', 'error');
                }
            });
        }

        // æ¸…é™¤åœ°å›¾æ ‡è®°å’Œè·¯çº¿
        function clearMap() {
            clearMarkers();
            if (currentRoute) {
                map.remove(currentRoute);
                currentRoute = null;
            }
            document.getElementById('dest-input').value = '';
            document.getElementById('navBtn').disabled = true;
            showTip('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰è·¯çº¿å’Œæ ‡è®°', 'default');
        }

        // æ¸…é™¤æ ‡è®°
        function clearMarkers() {
            markers.forEach(marker => {
                map.remove(marker);
            });
            markers = [];
        }

        // æ˜¾ç¤ºæç¤º
        function showTip(text, type) {
            const tip = document.getElementById('tip-text');
            tip.innerHTML = text;
            tip.className = type || 'default';
        }

        // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®æ›´æ–°
        function updateDeviceData() {
            if (!isLoggedIn) return;
            
            // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®
            const battery = Math.floor(Math.random() * 20 + 80); // 80-100%
            const temperature = Math.floor(Math.random() * 10 + 25); // 25-35Â°C
            
            document.getElementById('battery-status').textContent = `${battery}%`;
            document.getElementById('temp-status').textContent = `${temperature}Â°C`;
            
            // ç”µæ± é¢œè‰²æç¤º
            const batteryEl = document.getElementById('battery-status');
            batteryEl.className = battery > 30 ? 'success' : 'error';
            
            // æ¸©åº¦é¢œè‰²æç¤º
            const tempEl = document.getElementById('temp-status');
            tempEl.className = temperature < 40 ? 'success' : 'error';
        }
    </script>
</body>
</html>
