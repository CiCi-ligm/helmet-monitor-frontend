<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤´ç›”å¯¼èˆª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { padding: 20px; background: #f0f0f0; font-family: Arial; }
        #container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        h1 { text-align: center; color: #1890ff; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; height: 40px; padding: 0 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { height: 40px; padding: 0 20px; background: #1890ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        #map { width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        #info { padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <div id="container">
        <h1>ğŸï¸ æ™ºèƒ½å¤´ç›”å¯¼èˆª</h1>
        
        <div class="controls">
            <input type="text" id="dest" placeholder="è¾“å…¥ç›®çš„åœ°ï¼Œå¦‚ï¼šå¤©å®‰é—¨">
            <button onclick="getMyLocation()" id="locBtn">ğŸ“ å®šä½</button>
            <button onclick="startNav()" id="navBtn" disabled>ğŸš€ å¯¼èˆª</button>
        </div>
        
        <div id="map"></div>
        <div id="info">ç‚¹å‡»"å®šä½"æŒ‰é’®å¼€å§‹</div>
        
        <div style="text-align: center; margin-top: 15px; color: #666; font-size: 12px;">
            é«˜å¾·Key: 977b6123358698744cd4f2a96e219145
        </div>
    </div>

    <!-- å…³é”®ï¼šåªç”¨é«˜å¾·åŸºç¡€åœ°å›¾APIï¼Œä¸åŠ æ’ä»¶ -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=977b6123358698744cd4f2a96e219145"></script>
    
    <script>
        // æœ€ç®€ä»£ç  - å»æ‰æ‰€æœ‰å¤æ‚é€»è¾‘
        let map = null;
        let myPos = null;
        let marker = null;
        
        // é¡µé¢åŠ è½½
        window.onload = function() {
            console.log("å¼€å§‹åˆå§‹åŒ–...");
            
            // ç›´æ¥åˆ›å»ºåœ°å›¾
            try {
                map = new AMap.Map('map', {
                    zoom: 12,
                    center: [116.397428, 39.90923], // åŒ—äº¬
                    resizeEnable: true
                });
                console.log("âœ… åœ°å›¾åˆ›å»ºæˆåŠŸ");
                document.getElementById('info').innerHTML = "åœ°å›¾åŠ è½½å®Œæˆï¼ç‚¹å‡»'å®šä½'æŒ‰é’®";
            } catch (e) {
                console.error("åœ°å›¾åˆ›å»ºå¤±è´¥:", e);
                document.getElementById('info').innerHTML = "åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢";
            }
        };
        
        // è·å–ä½ç½® - æœ€ç®€å•çš„æ–¹å¼
        function getMyLocation() {
            if (!map) return;
            
            const btn = document.getElementById('locBtn');
            btn.disabled = true;
            btn.innerHTML = "å®šä½ä¸­...";
            document.getElementById('info').innerHTML = "æ­£åœ¨è·å–ä½ç½®...";
            
            // ç›´æ¥ä½¿ç”¨æµè§ˆå™¨å®šä½ï¼ˆæœ€ç®€å•ï¼‰
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        // æˆåŠŸ
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        handleLocation(lng, lat, "æµè§ˆå™¨å®šä½");
                        btn.disabled = false;
                        btn.innerHTML = "ğŸ“ å®šä½";
                    },
                    function(err) {
                        // å¤±è´¥ - ä½¿ç”¨é«˜å¾·å®šä½
                        useAMapLocation(btn);
                    }
                );
            } else {
                // æµè§ˆå™¨ä¸æ”¯æŒï¼Œç”¨é«˜å¾·
                useAMapLocation(btn);
            }
        }
        
        // ä½¿ç”¨é«˜å¾·å®šä½
        function useAMapLocation(btn) {
            console.log("ä½¿ç”¨é«˜å¾·å®šä½...");
            
            // åŠ è½½å®šä½æ’ä»¶
            AMap.plugin('AMap.Geolocation', function() {
                const geo = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 5000
                });
                
                geo.getCurrentPosition(function(status, result) {
                    btn.disabled = false;
                    btn.innerHTML = "ğŸ“ å®šä½";
                    
                    if (status === 'complete') {
                        handleLocation(result.position.lng, result.position.lat, "é«˜å¾·å®šä½");
                    } else {
                        // éƒ½å¤±è´¥ï¼Œç”¨é»˜è®¤ä½ç½®
                        handleLocation(116.397428, 39.90923, "é»˜è®¤ä½ç½®");
                    }
                });
            });
        }
        
        // å¤„ç†ä½ç½®
        function handleLocation(lng, lat, source) {
            console.log("ä½ç½®è·å–æˆåŠŸ:", lng, lat, source);
            
            myPos = [lng, lat];
            
            // æ¸…é™¤æ—§æ ‡è®°
            if (marker) {
                map.remove(marker);
            }
            
            // åˆ›å»ºæ–°æ ‡è®°
            marker = new AMap.Marker({
                position: myPos,
                map: map,
                title: 'æˆ‘çš„ä½ç½®'
            });
            
            // ç§»åŠ¨åˆ°ä½ç½®
            map.setCenter(myPos);
            map.setZoom(16);
            
            // å¯ç”¨å¯¼èˆªæŒ‰é’®
            document.getElementById('navBtn').disabled = false;
            
            // æ˜¾ç¤ºä¿¡æ¯
            document.getElementById('info').innerHTML = `âœ… ${source}æˆåŠŸï¼å¯ä»¥å¼€å§‹å¯¼èˆª`;
            document.getElementById('info').style.color = "green";
        }
        
        // å¼€å§‹å¯¼èˆª
        function startNav() {
            if (!myPos) return;
            
            const dest = document.getElementById('dest').value.trim();
            if (!dest) {
                document.getElementById('info').innerHTML = "è¯·è¾“å…¥ç›®çš„åœ°";
                return;
            }
            
            const btn = document.getElementById('navBtn');
            btn.disabled = true;
            btn.innerHTML = "è§„åˆ’ä¸­...";
            document.getElementById('info').innerHTML = "æ­£åœ¨è§„åˆ’è·¯çº¿...";
            
            // åŠ è½½åœ°ç†ç¼–ç æ’ä»¶
            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder();
                
                geocoder.getLocation(dest, function(status, result) {
                    btn.disabled = false;
                    btn.innerHTML = "ğŸš€ å¯¼èˆª";
                    
                    if (status === 'complete' && result.geocodes.length > 0) {
                        const destPos = result.geocodes[0].location;
                        const destName = result.geocodes[0].formattedAddress;
                        
                        // æ·»åŠ ç›®çš„åœ°æ ‡è®°
                        new AMap.Marker({
                            position: destPos,
                            map: map,
                            title: destName
                        });
                        
                        // åŠ è½½è·¯çº¿è§„åˆ’æ’ä»¶
                        AMap.plugin('AMap.Driving', function() {
                            const driving = new AMap.Driving({
                                map: map,
                                policy: AMap.DrivingPolicy.LEAST_TIME
                            });
                            
                            driving.search(myPos, destPos, function(status, result) {
                                if (status === 'complete') {
                                    const route = result.routes[0];
                                    const dist = (route.distance / 1000).toFixed(1);
                                    const time = Math.ceil(route.time / 60);
                                    
                                    map.setFitView();
                                    document.getElementById('info').innerHTML = 
                                        `âœ… å¯¼èˆªå®Œæˆï¼<br>ç›®çš„åœ°ï¼š${destName}<br>è·ç¦»ï¼š${dist}å…¬é‡Œ<br>æ—¶é—´ï¼š${time}åˆ†é’Ÿ`;
                                    document.getElementById('info').style.color = "green";
                                } else {
                                    document.getElementById('info').innerHTML = "è·¯çº¿è§„åˆ’å¤±è´¥";
                                    document.getElementById('info').style.color = "red";
                                }
                            });
                        });
                        
                    } else {
                        document.getElementById('info').innerHTML = "æ‰¾ä¸åˆ°ç›®çš„åœ°";
                        document.getElementById('info').style.color = "red";
                    }
                });
            });
        }
        
        // æµ‹è¯•å‡½æ•°
        window.test = function() {
            console.log("æµ‹è¯•ï¼šæ¨¡æ‹Ÿå®šä½æˆåŠŸ");
            handleLocation(116.403865, 39.915085, "æµ‹è¯•ä½ç½®");
        };
    </script>
    
    <script>
        // é¡µé¢åŠ è½½æ£€æŸ¥
        console.log("===================================");
        console.log("æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿ - æç®€ç‰ˆ");
        console.log("é«˜å¾·KeyéªŒè¯:", window.AMap ? "âœ… åŠ è½½æˆåŠŸ" : "âŒ åŠ è½½å¤±è´¥");
        console.log("åœ°å›¾å¯¹è±¡:", map);
        console.log("æµ‹è¯•å‘½ä»¤: test() - æ¨¡æ‹Ÿå®šä½");
        console.log("===================================");
    </script>
</body>
</html>
