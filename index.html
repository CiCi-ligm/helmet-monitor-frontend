<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ™ºèƒ½å¤´ç›”å¯¼èˆª</title>
    <style>
        body, html { margin:0; padding:0; width:100%; height:100%; }
        #container { width:100%; height:100%; }
        .panel {
            position:absolute; top:20px; left:20px; 
            background:white; padding:20px; border-radius:10px;
            box-shadow:0 2px 10px rgba(0,0,0,0.1); z-index:999;
            width:300px;
        }
        input { width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:5px; }
        button { width:100%; padding:12px; margin:5px 0; background:#1890ff; color:white; border:none; border-radius:5px; cursor:pointer; }
        button:disabled { background:#ccc; }
        #status { margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px; }
    </style>
</head>
<body>
    <div id="container"></div>
    <div class="panel">
        <h3 style="margin-bottom:15px;">æ™ºèƒ½å¤´ç›”å¯¼èˆª</h3>
        <input type="text" id="dest" placeholder="è¾“å…¥ç›®çš„åœ°">
        <button onclick="getLocation()" id="locBtn">ğŸ“ è·å–ä½ç½®</button>
        <button onclick="startNav()" id="navBtn" disabled>ğŸš€ å¼€å§‹å¯¼èˆª</button>
        <div id="status">ç‚¹å‡»"è·å–ä½ç½®"å¼€å§‹</div>
    </div>

    <!-- æµ‹è¯•1ï¼šå…ˆç”¨ä¸€ä¸ªç®€å•çš„Keyè¯•è¯• -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=977b6123358698744cd4f2a96e219145"></script>

    <script>
        // å…ˆæ£€æŸ¥é«˜å¾·APIæ˜¯å¦åŠ è½½æˆåŠŸ
        if (!window.AMap) {
            document.getElementById('status').innerHTML = 
                'âŒ é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥<br>å¯èƒ½åŸå› ï¼š<br>1. ç½‘ç»œé—®é¢˜<br>2. Keyæ— æ•ˆ<br>3. æµè§ˆå™¨é˜»æ­¢';
            throw new Error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
        }
        
        console.log('âœ… é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
        
        // åˆ›å»ºåœ°å›¾
        var map = new AMap.Map('container', {
            zoom: 14,
            center: [116.397428, 39.90923], // åŒ—äº¬
            resizeEnable: true
        });
        
        console.log('âœ… åœ°å›¾åˆ›å»ºæˆåŠŸ');
        document.getElementById('status').innerHTML = 'âœ… åœ°å›¾åŠ è½½æˆåŠŸï¼';
        
        var myPos = null;
        var myMarker = null;
        
        // è·å–ä½ç½®
        function getLocation() {
            document.getElementById('locBtn').disabled = true;
            document.getElementById('locBtn').innerHTML = 'å®šä½ä¸­...';
            document.getElementById('status').innerHTML = 'æ­£åœ¨è·å–ä½ç½®...';
            
            // ä½¿ç”¨é«˜å¾·å®šä½
            AMap.plugin('AMap.Geolocation', function() {
                var geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                
                geolocation.getCurrentPosition(function(status, result) {
                    document.getElementById('locBtn').disabled = false;
                    document.getElementById('locBtn').innerHTML = 'ğŸ“ è·å–ä½ç½®';
                    
                    if (status === 'complete') {
                        // æˆåŠŸ
                        myPos = result.position;
                        
                        // ç§»é™¤æ—§æ ‡è®°
                        if (myMarker) {
                            map.remove(myMarker);
                        }
                        
                        // æ·»åŠ æ ‡è®°
                        myMarker = new AMap.Marker({
                            position: myPos,
                            map: map
                        });
                        
                        // ç§»åŠ¨åœ°å›¾
                        map.setCenter(myPos);
                        map.setZoom(16);
                        
                        // å¯ç”¨å¯¼èˆªæŒ‰é’®
                        document.getElementById('navBtn').disabled = false;
                        
                        document.getElementById('status').innerHTML = 
                            'âœ… å®šä½æˆåŠŸï¼<br>å¯ä»¥è¾“å…¥ç›®çš„åœ°å¯¼èˆª';
                        
                    } else {
                        // å¤±è´¥
                        document.getElementById('status').innerHTML = 
                            'âŒ å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®';
                        
                        // ä½¿ç”¨é»˜è®¤ä½ç½®
                        myPos = [116.397428, 39.90923];
                        
                        if (myMarker) {
                            map.remove(myMarker);
                        }
                        
                        myMarker = new AMap.Marker({
                            position: myPos,
                            map: map
                        });
                        
                        map.setCenter(myPos);
                        document.getElementById('navBtn').disabled = false;
                    }
                });
            });
        }
        
        // å¼€å§‹å¯¼èˆª
        function startNav() {
            if (!myPos) {
                document.getElementById('status').innerHTML = 'è¯·å…ˆè·å–ä½ç½®';
                return;
            }
            
            var dest = document.getElementById('dest').value.trim();
            if (!dest) {
                document.getElementById('status').innerHTML = 'è¯·è¾“å…¥ç›®çš„åœ°';
                return;
            }
            
            document.getElementById('navBtn').disabled = true;
            document.getElementById('navBtn').innerHTML = 'è§„åˆ’ä¸­...';
            document.getElementById('status').innerHTML = 'æ­£åœ¨è§„åˆ’è·¯çº¿...';
            
            // åœ°ç†ç¼–ç 
            AMap.plugin('AMap.Geocoder', function() {
                var geocoder = new AMap.Geocoder();
                
                geocoder.getLocation(dest, function(status, result) {
                    document.getElementById('navBtn').disabled = false;
                    document.getElementById('navBtn').innerHTML = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                    
                    if (status === 'complete' && result.geocodes.length > 0) {
                        var destPos = result.geocodes[0].location;
                        
                        // æ·»åŠ ç›®çš„åœ°æ ‡è®°
                        var destMarker = new AMap.Marker({
                            position: destPos,
                            map: map
                        });
                        
                        // è·¯çº¿è§„åˆ’
                        AMap.plugin('AMap.Driving', function() {
                            var driving = new AMap.Driving({
                                map: map,
                                policy: AMap.DrivingPolicy.LEAST_TIME
                            });
                            
                            driving.search(myPos, destPos, function(status, result) {
                                if (status === 'complete') {
                                    map.setFitView();
                                    document.getElementById('status').innerHTML = 'âœ… å¯¼èˆªè§„åˆ’å®Œæˆï¼';
                                } else {
                                    document.getElementById('status').innerHTML = 'âŒ è·¯çº¿è§„åˆ’å¤±è´¥';
                                }
                            });
                        });
                        
                    } else {
                        document.getElementById('status').innerHTML = 'âŒ æ‰¾ä¸åˆ°ç›®çš„åœ°';
                    }
                });
            });
        }
        
        // é¡µé¢åŠ è½½åæµ‹è¯•
        console.log('é¡µé¢åŠ è½½å®Œæˆ');
        console.log('é«˜å¾·Key:', '977b6123358698744cd4f2a96e219145');
        
        // æµ‹è¯•ï¼šç›´æ¥æ˜¾ç¤ºåœ°å›¾
        setTimeout(function() {
            if (map.getSize && map.getSize().width > 0) {
                console.log('âœ… åœ°å›¾æ¸²æŸ“æˆåŠŸ');
                document.getElementById('status').innerHTML = 'âœ… åœ°å›¾åŠ è½½æˆåŠŸï¼ç‚¹å‡»"è·å–ä½ç½®"';
            } else {
                console.log('âŒ åœ°å›¾æ¸²æŸ“å¤±è´¥');
                document.getElementById('status').innerHTML = 
                    'åœ°å›¾æ¸²æŸ“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯';
            }
        }, 1000);
    </script>
</body>
</html>
