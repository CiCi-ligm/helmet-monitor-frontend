<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿ - æœ€ç»ˆæµ‹è¯•</title>
    <style>
        body { padding: 20px; font-family: Arial; max-width: 1000px; margin: 0 auto; }
        #map { width: 100%; height: 500px; border: 3px solid #1890ff; border-radius: 10px; margin: 20px 0; }
        .controls { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        input { flex: 1; min-width: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 12px 24px; background: #1890ff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1 style="color: #1890ff; text-align: center;">ğŸï¸ æ™ºèƒ½å¤´ç›”å®æ—¶å¯¼èˆªç³»ç»Ÿ</h1>
    
    <div class="controls">
        <input type="text" id="dest" placeholder="è¾“å…¥ç›®çš„åœ°ï¼Œå¦‚ï¼šå¤©å®‰é—¨å¹¿åœºã€åŒ—äº¬å¤§å­¦">
        <button onclick="getLocation()" id="locBtn">ğŸ“ è·å–æˆ‘çš„ä½ç½®</button>
        <button onclick="searchDestination()" id="searchBtn" disabled>ğŸ” æœç´¢ç›®çš„åœ°</button>
        <button onclick="startNavigation()" id="navBtn" disabled>ğŸš€ å¼€å§‹å¯¼èˆª</button>
    </div>
    
    <div id="map"></div>
    
    <div id="status" class="status info">
        <h3>ğŸ“¡ ç³»ç»ŸçŠ¶æ€</h3>
        <p>ç­‰å¾…è·å–ä½ç½®ä¿¡æ¯...</p>
        <p><small>ç‚¹å‡»"è·å–æˆ‘çš„ä½ç½®"æŒ‰é’®å¼€å§‹</small></p>
    </div>
    
    <div style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
        <p>Â© 2024 æ™ºèƒ½å¤´ç›”é¡¹ç›® - åµŒå…¥å¼æ¯”èµ›ç³»ç»Ÿ</p>
        <p>é«˜å¾·åœ°å›¾API Key: 977b6123358698744cd4f2a96e219145</p>
    </div>
    
    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=977b6123358698744cd4f2a96e219145"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let myLocation = null;
        let destination = null;
        let myMarker = null;
        let destMarker = null;
        let driving = null;
        
        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            initMap();
        };
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            try {
                map = new AMap.Map('map', {
                    zoom: 14,
                    center: [116.397428, 39.90923], // åŒ—äº¬
                    resizeEnable: true,
                    viewMode: '2D'
                });
                
                // æ·»åŠ å·¥å…·æ 
                map.addControl(new AMap.ToolBar({
                    position: 'RT'
                }));
                
                updateStatus('âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼<br>è¯·ç‚¹å‡»"è·å–æˆ‘çš„ä½ç½®"æŒ‰é’®', 'success');
                console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                
            } catch (error) {
                updateStatus('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message, 'error');
                console.error('åœ°å›¾é”™è¯¯:', error);
            }
        }
        
        // è·å–æˆ‘çš„ä½ç½®
        function getLocation() {
            if (!map) {
                updateStatus('åœ°å›¾æœªå°±ç»ª', 'error');
                return;
            }
            
            const btn = document.getElementById('locBtn');
            btn.disabled = true;
            btn.innerHTML = 'å®šä½ä¸­...';
            
            updateStatus('ğŸ” æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...', 'info');
            
            // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå®šä½ï¼ˆæœ€ç®€å•ç›´æ¥ï¼‰
            if (navigator.geolocation) {
                console.log('å¼€å§‹æµè§ˆå™¨å®šä½...');
                
                navigator.geolocation.getCurrentPosition(
                    // æˆåŠŸå›è°ƒ
                    function(position) {
                        console.log('æµè§ˆå™¨å®šä½æˆåŠŸ:', position);
                        
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        myLocation = [lng, lat];
                        
                        // æ¸…é™¤æ—§æ ‡è®°
                        if (myMarker) {
                            map.remove(myMarker);
                        }
                        
                        // åˆ›å»ºæˆ‘çš„ä½ç½®æ ‡è®°
                        myMarker = new AMap.Marker({
                            position: myLocation,
                            map: map,
                            title: 'æˆ‘çš„ä½ç½®',
                            content: '<div style="background:#1890ff;width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3);"></div>'
                        });
                        
                        // ç§»åŠ¨åˆ°æˆ‘çš„ä½ç½®
                        map.setCenter(myLocation);
                        map.setZoom(16);
                        
                        // å¯ç”¨å…¶ä»–æŒ‰é’®
                        document.getElementById('searchBtn').disabled = false;
                        document.getElementById('navBtn').disabled = false;
                        
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ“ è·å–æˆ‘çš„ä½ç½®';
                        
                        updateStatus(
                            `âœ… å®šä½æˆåŠŸï¼<br>
                             ğŸ“ ä½ç½®è·å–å®Œæˆ<br>
                             çº¬åº¦: ${lat.toFixed(6)}<br>
                             ç»åº¦: ${lng.toFixed(6)}<br>
                             ç²¾åº¦: ${accuracy ? accuracy.toFixed(1) + 'ç±³' : 'é«˜ç²¾åº¦'}`,
                            'success'
                        );
                        
                        console.log('ä½ç½®å·²è®¾ç½®:', myLocation);
                        
                    },
                    // å¤±è´¥å›è°ƒ
                    function(error) {
                        console.error('æµè§ˆå™¨å®šä½å¤±è´¥:', error);
                        
                        let message = 'å®šä½å¤±è´¥ï¼š';
                        switch(error.code) {
                            case 1:
                                message += 'ç”¨æˆ·æ‹’ç»å®šä½æƒé™';
                                break;
                            case 2:
                                message += 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                                break;
                            case 3:
                                message += 'å®šä½è¯·æ±‚è¶…æ—¶';
                                break;
                            default:
                                message += error.message;
                        }
                        
                        updateStatus('âŒ ' + message + '<br>è¯·æ£€æŸ¥æµè§ˆå™¨å®šä½è®¾ç½®', 'error');
                        
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ“ è·å–æˆ‘çš„ä½ç½®';
                        
                        // å¦‚æœå®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                        useDefaultLocation();
                    },
                    // é…ç½®
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½', 'error');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“ è·å–æˆ‘çš„ä½ç½®';
            }
        }
        
        // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆæ¼”ç¤ºç”¨ï¼‰
        function useDefaultLocation() {
            updateStatus('âš ï¸ ä½¿ç”¨é»˜è®¤ä½ç½®è¿›è¡Œæ¼”ç¤º', 'info');
            
            myLocation = [116.403865, 39.915085]; // æ•…å®«
            
            if (myMarker) {
                map.remove(myMarker);
            }
            
            myMarker = new AMap.Marker({
                position: myLocation,
                map: map,
                title: 'é»˜è®¤ä½ç½®ï¼ˆæ•…å®«ï¼‰',
                content: '<div style="background:#f59e0b;width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3);"></div>'
            });
            
            map.setCenter(myLocation);
            map.setZoom(15);
            
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('navBtn').disabled = false;
        }
        
        // æœç´¢ç›®çš„åœ°
        function searchDestination() {
            const dest = document.getElementById('dest').value.trim();
            if (!dest) {
                updateStatus('è¯·è¾“å…¥ç›®çš„åœ°', 'error');
                return;
            }
            
            updateStatus('ğŸ” æ­£åœ¨æœç´¢ç›®çš„åœ°...', 'info');
            
            // æ¸…é™¤æ—§çš„ç›®çš„åœ°æ ‡è®°
            if (destMarker) {
                map.remove(destMarker);
            }
            
            // åŠ è½½åœ°ç†ç¼–ç æ’ä»¶
            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder();
                
                geocoder.getLocation(dest, function(status, result) {
                    if (status === 'complete' && result.geocodes.length > 0) {
                        destination = result.geocodes[0].location;
                        const destName = result.geocodes[0].formattedAddress;
                        
                        // åˆ›å»ºç›®çš„åœ°æ ‡è®°
                        destMarker = new AMap.Marker({
                            position: destination,
                            map: map,
                            title: destName,
                            content: '<div style="background:#ef4444;width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3);">ğŸ</div>'
                        });
                        
                        // ç§»åŠ¨åˆ°ç›®çš„åœ°
                        map.setCenter(destination);
                        map.setZoom(15);
                        
                        updateStatus(`âœ… æ‰¾åˆ°ç›®çš„åœ°ï¼š${destName}`, 'success');
                        
                    } else {
                        updateStatus('âŒ æ‰¾ä¸åˆ°ç›®çš„åœ°ï¼Œè¯·æ£€æŸ¥åœ°å€', 'error');
                    }
                });
            });
        }
        
        // å¼€å§‹å¯¼èˆª
        function startNavigation() {
            if (!myLocation) {
                updateStatus('è¯·å…ˆè·å–æ‚¨çš„ä½ç½®', 'error');
                return;
            }
            
            const dest = document.getElementById('dest').value.trim();
            if (!dest) {
                updateStatus('è¯·è¾“å…¥ç›®çš„åœ°', 'error');
                return;
            }
            
            const btn = document.getElementById('navBtn');
            btn.disabled = true;
            btn.innerHTML = 'è§„åˆ’ä¸­...';
            
            updateStatus('ğŸ—ºï¸ æ­£åœ¨è§„åˆ’æœ€ä½³è·¯çº¿...', 'info');
            
            // æ¸…é™¤æ—§çš„è·¯çº¿
            if (driving) {
                map.remove(driving);
            }
            
            // å¦‚æœæ²¡æœ‰ç›®çš„åœ°åæ ‡ï¼Œå…ˆæœç´¢
            if (!destination) {
                AMap.plugin('AMap.Geocoder', function() {
                    const geocoder = new AMap.Geocoder();
                    
                    geocoder.getLocation(dest, function(status, result) {
                        if (status === 'complete' && result.geocodes.length > 0) {
                            destination = result.geocodes[0].location;
                            planRoute();
                        } else {
                            updateStatus('âŒ æ‰¾ä¸åˆ°ç›®çš„åœ°', 'error');
                            btn.disabled = false;
                            btn.innerHTML = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                        }
                    });
                });
            } else {
                planRoute();
            }
            
            function planRoute() {
                // åŠ è½½é©¾è½¦å¯¼èˆªæ’ä»¶
                AMap.plugin('AMap.Driving', function() {
                    driving = new AMap.Driving({
                        map: map,
                        policy: AMap.DrivingPolicy.LEAST_TIME,
                        showTraffic: true,
                        hideMarkers: true
                    });
                    
                    driving.search(myLocation, destination, function(status, result) {
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸš€ å¼€å§‹å¯¼èˆª';
                        
                        if (status === 'complete') {
                            const route = result.routes[0];
                            const time = Math.ceil(route.time / 60);
                            const distance = (route.distance / 1000).toFixed(1);
                            
                            map.setFitView();
                            
                            updateStatus(
                                `âœ… å¯¼èˆªè§„åˆ’å®Œæˆï¼<br>
                                 ğŸ“ è·¯çº¿å·²è§„åˆ’<br>
                                 ğŸ“ è·ç¦»: ${distance}å…¬é‡Œ<br>
                                 â±ï¸ é¢„è®¡æ—¶é—´: ${time}åˆ†é’Ÿ`,
                                'success'
                            );
                            
                            console.log('å¯¼èˆªæˆåŠŸ:', route);
                            
                        } else {
                            updateStatus('âŒ è·¯çº¿è§„åˆ’å¤±è´¥', 'error');
                        }
                    });
                });
            }
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(text, type) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<h3>ğŸ“¡ ç³»ç»ŸçŠ¶æ€</h3>${text}`;
            
            // æ¸…é™¤æ‰€æœ‰æ ·å¼ç±»
            statusEl.className = 'status';
            
            // æ·»åŠ æ–°æ ·å¼
            if (type === 'success') {
                statusEl.classList.add('success');
            } else if (type === 'error') {
                statusEl.classList.add('error');
            } else {
                statusEl.classList.add('info');
            }
        }
        
        // è°ƒè¯•å‘½ä»¤
        window.debugLocation = function() {
            console.log('å½“å‰ä½ç½®:', myLocation);
            console.log('ç›®çš„åœ°:', destination);
            console.log('åœ°å›¾å¯¹è±¡:', map);
            
            if (myLocation) {
                alert(`å½“å‰ä½ç½®: ${myLocation[1]}, ${myLocation[0]}`);
            } else {
                alert('æš‚æ— ä½ç½®ä¿¡æ¯');
            }
        };
        
        console.log('æ™ºèƒ½å¤´ç›”å¯¼èˆªç³»ç»Ÿå·²åŠ è½½');
        console.log('é«˜å¾·KeyçŠ¶æ€: å·²é…ç½®');
        console.log('æµè§ˆå™¨å®šä½æ”¯æŒ:', !!navigator.geolocation);
    </script>
</body>
</html>
