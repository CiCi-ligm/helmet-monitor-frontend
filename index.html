<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤´ç›”ç›‘æ§å¯¼èˆªç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            padding: 20px;
            background: #f5f5f5;
            /* å–æ¶ˆå¤šä½™åŠ¨ç”»ï¼Œå‡å°‘å¡é¡¿ */
            animation: none;
            transition: none;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        /* ç™»å½•æ¨¡å— - ç®€æ´æ— å†—ä½™ */
        .login-wrap {
            width: 380px;
            margin: 60px auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-wrap h2 {
            color: #0078d7;
            margin-bottom: 25px;
            font-size: 22px;
        }
        .login-wrap input {
            width: 100%;
            height: 45px;
            margin: 10px 0;
            padding: 0 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
        }
        .login-wrap input:focus {
            border-color: #0078d7;
        }
        .login-wrap button {
            width: 100%;
            height: 45px;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 5px;
        }
        .login-wrap button:hover {
            background: #005a9e;
        }
        /* åŠŸèƒ½æ¨¡å— - è½»é‡æ— å¤šä½™ */
        .func-wrap {
            display: none;
        }
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            height: 40px;
            padding: 0 20px;
            background: #f53f3f;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            z-index: 999;
        }
        .nav-module {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .nav-module h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .nav-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #dest-input {
            flex: 1;
            min-width: 280px;
            height: 45px;
            padding: 0 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
        }
        #dest-input:focus {
            border-color: #0078d7;
        }
        .nav-btn {
            height: 45px;
            padding: 0 25px;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .nav-btn:hover {
            background: #005a9e;
        }
        #map-container {
            width: 100%;
            height: 500px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        #tip-text {
            margin-top: 12px;
            font-size: 14px;
        }
        .success { color: #00b42a; }
        .error { color: #f53f3f; }
        .default { color: #666; }
    </style>
    <!-- é«˜å¾·åœ°å›¾API - ç²¾ç®€ç‰ˆï¼ŒåªåŠ è½½æ ¸å¿ƒ -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=e2e067c5006e95799f9f27327f568f88e" async defer></script>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ - å”¯ä¸€å…¥å£ï¼Œæ— å†—ä½™ -->
    <div class="login-wrap" id="loginPage">
        <h2>æ™ºèƒ½å¤´ç›”ç³»ç»Ÿç™»å½•</h2>
        <input type="text" id="user" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        <input type="password" id="pwd" placeholder="è¯·è¾“å…¥å¯†ç ">
        <button onclick="login()">ç™» å½•</button>
    </div>

    <!-- åŠŸèƒ½é¡µé¢ - é»˜è®¤éšè—ï¼Œç™»å½•åæ˜¾ç¤º -->
    <div class="container func-wrap" id="funcPage">
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        <div class="nav-module">
            <h2>å¤´ç›”å®æ—¶å¯¼èˆª</h2>
            <div class="nav-controls">
                <input type="text" id="dest-input" placeholder="è¯·è¾“å…¥ç›®çš„åœ°ï¼ˆä¾‹ï¼šå¤©å®‰é—¨å¹¿åœºï¼‰">
                <button class="nav-btn" onclick="getLocation()">è·å–å½“å‰å®šä½</button>
                <button class="nav-btn" onclick="goNav()">å¼€å§‹å¯¼èˆª</button>
            </div>
            <div id="map-container"></div>
            <div id="tip-text" class="default">è¯·å…ˆè·å–å½“å‰å®šä½ï¼Œå†è¾“å…¥ç›®çš„åœ°å¯¼èˆª</div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡åªå®šä¹‰å¿…è¦çš„ï¼Œå‡å°‘å†…å­˜å ç”¨
        let map = null;
        let myLoc = null;
        // å…³é—­æ‰€æœ‰å¤šä½™å®šæ—¶å™¨ï¼Œè§£å†³å¡é¡¿æ ¸å¿ƒ
        clearInterval(window.timer);
        clearTimeout(window.timeout);

        // é¡µé¢åŠ è½½åªåšä¸€ä»¶äº‹ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œæ— å¤šä½™æ“ä½œ
        window.onload = function() {
            checkLoginStatus();
        };

        // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€ - æç®€é€»è¾‘ï¼Œä¸è€—èµ„æº
        function checkLoginStatus() {
            const isLogin = localStorage.getItem('helmet_is_login');
            if (isLogin === 'yes') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('funcPage').style.display = 'block';
                initMap(); // åªåˆå§‹åŒ–ä¸€æ¬¡åœ°å›¾ï¼Œä¸é‡å¤åŠ è½½
            } else {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('funcPage').style.display = 'none';
            }
        }

        // 2. ç™»å½• - æ— å¤šä½™æ ¡éªŒï¼ŒæˆåŠŸå³ä¿å­˜
        function login() {
            const user = document.getElementById('user').value.trim();
            const pwd = document.getElementById('pwd').value.trim();
            if (!user || !pwd) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼');
                return;
            }
            // åªå­˜å¿…è¦çš„ç™»å½•çŠ¶æ€ï¼Œå‡å°‘localStorageå ç”¨
            localStorage.setItem('helmet_is_login', 'yes');
            checkLoginStatus();
            alert('ç™»å½•æˆåŠŸï¼');
        }

        // 3. é€€å‡ºç™»å½• - å½»åº•æ¸…é™¤ï¼Œä¸æ®‹ç•™
        function logout() {
            localStorage.removeItem('helmet_is_login');
            window.location.reload(); // åˆ·æ–°ä¸€æ¬¡ï¼Œå½»åº•é‡Šæ”¾èµ„æº
        }

        // 4. åˆå§‹åŒ–åœ°å›¾ - åªæ‰§è¡Œä¸€æ¬¡ï¼Œè§£å†³åå¤åŠ è½½å¡é¡¿
        function initMap() {
            if (map) return; // åœ°å›¾å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            map = new AMap.Map('map-container', {
                zoom: 16,
                center: [116.397428, 39.90923],
                resizeEnable: true,
                // å…³é—­åœ°å›¾å¤šä½™åŠ¨ç”»ï¼Œå‡å°‘CPUå ç”¨
                animateEnable: false
            });
            map.addControl(new AMap.ToolBar({ liteStyle: true })); // è½»é‡æ§ä»¶ï¼Œæ›´æµç•…
            // é¢„åŠ è½½ä¸€æ¬¡å®šä½/å¯¼èˆªæ’ä»¶ï¼Œä¸é‡å¤è¯·æ±‚
            AMap.plugin(['AMap.Geolocation', 'AMap.Geocoder', 'AMap.Driving'], () => {});
        }

        // 5. è·å–å®šä½ - 3ç§’è¶…æ—¶+å…œåº•ï¼Œæé€Ÿä¸å¡é¡¿
        function getLocation() {
            if (!map) initMap();
            setTip('ğŸ” æ­£åœ¨å®šä½...', 'default');
            // é«˜å¾·åŸç”Ÿå®šä½ï¼Œæ¯”æµè§ˆå™¨å¿«ä¸”ä¸è€—èµ„æº
            const geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 3000, // ä¸¥æ ¼3ç§’è¶…æ—¶ï¼Œç»ä¸å¡æ­»
                buttonPosition: 'RB'
            });
            // åªæ‰§è¡Œä¸€æ¬¡å®šä½ï¼Œä¸é‡å¤è§¦å‘
            geolocation.getCurrentPosition((status, res) => {
                if (status === 'complete') {
                    myLoc = res.position;
                    map.setCenter(myLoc);
                    // åªåŠ ä¸€ä¸ªæ ‡è®°ï¼Œä¸é‡å¤æ·»åŠ 
                    new AMap.Marker({
                        position: myLoc,
                        map: map,
                        icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png'
                    });
                    setTip('âœ… å®šä½æˆåŠŸï¼å¯è¾“å…¥ç›®çš„åœ°å¯¼èˆª', 'success');
                } else {
                    setTip('âŒ é«˜ç²¾åº¦å®šä½å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åŸå¸‚å®šä½', 'error');
                    // å…œåº•IPå®šä½ï¼Œè½»é‡ä¸è€—èµ„æº
                    AMap.plugin('AMap.CitySearch', () => {
                        new AMap.CitySearch().getLocalCity((s, r) => {
                            if (s === 'complete') {
                                myLoc = r.center;
                                map.setCenter(myLoc);
                                setTip('âš ï¸ åŸå¸‚å®šä½æˆåŠŸï¼Œç»§ç»­ä½¿ç”¨', 'default');
                            }
                        });
                    });
                }
            });
        }

        // 6. å¼€å§‹å¯¼èˆª - æç®€é€»è¾‘ï¼Œç§’å‡ºè·¯çº¿
        function goNav() {
            if (!myLoc) {
                setTip('âš ï¸ è¯·å…ˆç‚¹å‡»è·å–å½“å‰å®šä½ï¼', 'error');
                return;
            }
            const dest = document.getElementById('dest-input').value.trim();
            if (!dest) {
                setTip('âš ï¸ è¯·è¾“å…¥ç›®çš„åœ°ï¼', 'error');
                return;
            }
            setTip('ğŸ—ºï¸ æ­£åœ¨è§„åˆ’è·¯çº¿...', 'default');
            // åœ°å€è§£æ+è·¯çº¿è§„åˆ’ï¼Œä¸€æ­¥åˆ°ä½ï¼Œæ— å¤šä½™è¯·æ±‚
            new AMap.Geocoder().getLocation(dest, (s1, r1) => {
                if (s1 !== 'complete') {
                    setTip('âŒ åœ°å€è§£æå¤±è´¥ï¼Œè¯·è¾“å…¥å‡†ç¡®åœ°å€ï¼', 'error');
                    return;
                }
                const destLoc = r1.geocodes[0].location;
                new AMap.Marker({
                    position: destLoc,
                    map: map,
                    icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                });
                new AMap.Driving({ map: map, animateEnable: false }).search(myLoc, destLoc, (s2, r2) => {
                    if (s2 === 'complete') {
                        const route = r2.routes[0];
                        setTip(`ğŸ‰ å¯¼èˆªæˆåŠŸï¼é¢„è®¡${Math.ceil(route.time/60)}åˆ†é’Ÿ | å…¨ç¨‹${(route.distance/1000).toFixed(1)}km`, 'success');
                    } else {
                        setTip('âŒ è·¯çº¿è§„åˆ’å¤±è´¥ï¼Œè¯·æ›´æ¢ç›®çš„åœ°ï¼', 'error');
                    }
                });
            });
        }

        // 7. æç¤ºæ¡† - æç®€å‡½æ•°ï¼Œä¸è€—èµ„æº
        function setTip(text, type) {
            const tip = document.getElementById('tip-text');
            tip.innerText = text;
            tip.className = type;
        }
    </script>
</body>
</html>
